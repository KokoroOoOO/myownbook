<!DOCTYPE html>
<html lang="zh">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹å®éªŒ</title>
    <script src="experiment-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script>
        // åŒæ ·çš„ Firebase é…ç½®ï¼ˆç¡®ä¿projectIdç­‰ä¸€è‡´ï¼‰
        const firebaseConfig = {
    apiKey: "AIzaSyCUp72tIZBypw-HgVhVQWN88egtH4uyuL0",
    authDomain: "redbook-31e18.firebaseapp.com",
    projectId: "redbook-31e18",
    storageBucket: "redbook-31e18.firebasestorage.app",
    messagingSenderId: "568218518846",
    appId: "1:568218518846:web:aaa8eb53765749b856d86f",
    measurementId: "G-WGQS7TLVTT"
  };
        firebase.initializeApp(firebaseConfig);
      
        // åªè¯»åŒæ­¥é€»è¾‘ï¼ˆç”¨æˆ·ç«¯ä¸“ç”¨ï¼‰
        const db = firebase.firestore();
        db.collection("appData").onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = change.doc.data().value;
            localStorage.setItem(change.doc.id, JSON.stringify(data));
          });
        });
      </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.2em;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 30px;
        }

        .category-card {
            background-color: white;
            padding: 40px 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .category-card h2 {
            margin: 15px 0 0;
            color: #333;
            font-size: 1.8em;
        }

        .category-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        /* ä¸ºæ¯ä¸ªç±»åˆ«æ·»åŠ ç‰¹å®šæ ·å¼ */
        .category-card[onclick*="food"] {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
        }

        .category-card[onclick*="pets"] {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .category-card[onclick*="beauty"] {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        }

        .category-card[onclick*="travel"] {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .category-card {
                padding: 30px 20px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 30px;
            }
        }

        /* æ·»åŠ å›¾æ ‡ */
        .category-card::before {
            font-size: 2.5em;
            margin-bottom: 15px;
            display: block;
        }

        .category-card[onclick*="food"]::before {
            content: "ğŸ³";
        }

        .category-card[onclick*="pets"]::before {
            content: "ğŸ±";
        }

        .category-card[onclick*="beauty"]::before {
            content: "ğŸ’„";
        }

        .category-card[onclick*="travel"]::before {
            content: "âœˆï¸";
        }
        .consent-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .consent-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }
        .consent-buttons {
            margin-top: 20px;
            text-align: center;
        }
        .consent-buttons button {
            margin: 0 15px;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .consent-buttons button:first-child {
            background: #4CAF50;
            color: white;
        }
        .consent-buttons button:last-child {
            background: #f44336;
            color: white;
        }
    </style>
</head>

<body>
    <!-- çŸ¥æƒ…åŒæ„è¡¨å•åº”è¯¥åœ¨æœ€å‰é¢ -->
    <div id="consentForm" class="consent-overlay" style="display: flex;">
        <div class="consent-content">
            <h2>å®éªŒçŸ¥æƒ…åŒæ„ä¹¦</h2>
            <p>äº²çˆ±çš„å‚ä¸è€…ï¼š</p>
            <p>æœ¬ç ”ç©¶æ—¨åœ¨æ¢ç©¶ç¤¾äº¤åª’ä½“å†…å®¹çš„ç”¨æˆ·ä½“éªŒã€‚æ‚¨çš„å‚ä¸å°†æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°ç†è§£å†…å®¹æ„ŸçŸ¥å’Œäº’åŠ¨è¡Œä¸ºã€‚</p>
            
            <h3>å®éªŒè¯´æ˜ï¼š</h3>
            <ul>
                <li>é¢„è®¡ç”¨æ—¶ï¼š15-20åˆ†é’Ÿ</li>
                <li>ä»»åŠ¡ï¼šæµè§ˆå†…å®¹å¹¶è¿›è¡Œè‡ªç„¶äº’åŠ¨</li>
                <li>æ•°æ®æ”¶é›†ï¼šäº¤äº’è¡Œä¸ºã€æµè§ˆæ—¶é—´ç­‰</li>
            </ul>

            <h3>éšç§ä¿æŠ¤ï¼š</h3>
            <ul>
                <li>æ‰€æœ‰æ•°æ®å°†åŒ¿åå¤„ç†</li>
                <li>ä»…ç”¨äºå­¦æœ¯ç ”ç©¶</li>
                <li>ä¸ä¼šæ”¶é›†ä¸ªäººèº«ä»½ä¿¡æ¯</li>
            </ul>

            <div class="consent-buttons">
                <button onclick="agreeConsent()">åŒæ„å‚ä¸</button>
                <button onclick="disagreeConsent()">æ‹’ç»å‚ä¸</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹å®¹å™¨ï¼Œé»˜è®¤éšè— -->
    <div class="container" style="display: none;">
        <h1>è¯·é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„å†…å®¹åˆ†ç±»</h1>
        <div class="category-grid">
            <div class="category-card" onclick="selectCategory('food')">
                <h2>ç¾é£Ÿ</h2>
            </div>
            <div class="category-card" onclick="selectCategory('pets')">
                <h2>èŒå® </h2>
            </div>
            <div class="category-card" onclick="selectCategory('beauty')">
                <h2>ç¾å¦†</h2>
            </div>
            <div class="category-card" onclick="selectCategory('travel')">
                <h2>æ—…æ¸¸</h2>
            </div>
        </div>
    </div>

    <script>
        
        // æ·»åŠ å®éªŒç³»ç»Ÿå¯¹è±¡ï¼Œç¡®ä¿åœ¨å…¶ä»–ä»£ç ä¹‹å‰å®šä¹‰
        const ExperimentSystem = {
            init: function() {
                this.startTime = Date.now();
                this.attachEventListeners();
                this.initializeExperiment();
                // æ˜¾ç¤ºä¸»å†…å®¹
                document.querySelector('.container').style.display = 'block';
            },
            
            initializeExperiment: function() {
                // éšæœºåˆ†é…ç”¨æˆ·ç»„
                if (!localStorage.getItem('userGroup')) {
                    const userGroup = Math.random() < 0.5 ? 'A' : 'B';
                    localStorage.setItem('userGroup', userGroup);
                }

                // åˆå§‹åŒ–å®éªŒæ•°æ®ç»“æ„
                const experimentData = {
                    startTime: new Date().toISOString(),
                    userGroup: localStorage.getItem('userGroup'),
                    interactions: []
                };
                localStorage.setItem('experimentData', JSON.stringify(experimentData));
            },
            attachEventListeners: function() {
                // æ·»åŠ é¡µé¢å¯è§æ€§ç›‘å¬
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.logEvent('page_hide');
                    } else {
                        this.logEvent('page_show');
                    }
                });
            },
            logEvent: function(eventType, details = {}) {
                const experimentData = JSON.parse(localStorage.getItem('experimentData') || '{"interactions":[]}');
                experimentData.interactions.push({
                    timestamp: new Date().toISOString(),
                    eventType,
                    details
                });
                localStorage.setItem('experimentData', JSON.stringify(experimentData));
            }
        };

        // ä¿®æ”¹åŒæ„å‡½æ•°
        function agreeConsent() {
            localStorage.setItem('consentGiven', 'true');
            localStorage.setItem('consentTimestamp', new Date().toISOString());
            
            // éšè—çŸ¥æƒ…åŒæ„è¡¨å•
            document.getElementById('consentForm').style.display = 'none';
            
            // æ˜¾ç¤ºä¸»å†…å®¹
            document.querySelector('.container').style.display = 'block';
            
            // åˆå§‹åŒ–å®éªŒç³»ç»Ÿ
            ExperimentSystem.init();
            
            // è®°å½•åŒæ„äº‹ä»¶
            ExperimentSystem.logEvent('consent_given');
        }

        // ä¿®æ”¹æ‹’ç»å‡½æ•°
        function disagreeConsent() {
            ExperimentSystem.logEvent('consent_rejected');
            window.location.href = 'about:blank';
        }

        // é¡µé¢åŠ è½½æ—¶çš„å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸…é™¤localStorageï¼ˆç”¨äºæµ‹è¯•ï¼‰
            // localStorage.removeItem('consentGiven');
            
            // è®¾ç½®åˆå§‹æ˜¾ç¤ºçŠ¶æ€
            const hasConsent = localStorage.getItem('consentGiven') === 'true';
            document.getElementById('consentForm').style.display = hasConsent ? 'none' : 'flex';
            document.querySelector('.container').style.display = hasConsent ? 'block' : 'none';
            
            // å¦‚æœå·²ç»åŒæ„ï¼Œåˆå§‹åŒ–å®éªŒç³»ç»Ÿ
            if (hasConsent) {
                ExperimentSystem.init();
            }
        });

        // åˆå§‹åŒ–ç”¨æˆ·äº¤äº’ç³»ç»Ÿ
        const UserInteractionSystem = {
            generateUserId: function() {
                if (!sessionStorage.getItem('userId')) {
                    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('userId', userId);
                }
                return sessionStorage.getItem('userId');
            },

            logInteraction: function(category, interactionType, details = {}) {
                const userId = this.generateUserId();
                const userGroup = sessionStorage.getItem('userGroup');
                const interaction = {
                    userId,
                    userGroup,
                    category,
                    interactionType,
                    details,
                    timestamp: new Date().toISOString()
                };

                let interactions = JSON.parse(localStorage.getItem('userInteractions')) || [];
                interactions.push(interaction);
                localStorage.setItem('userInteractions', JSON.stringify(interactions));
            }
        };

        // é€‰æ‹©åˆ†ç±»å‡½æ•°
        function selectCategory(category) {
            try {
                console.log('Selecting category:', category); // è°ƒè¯•ä¿¡æ¯

                // éšæœºåˆ†é…ç”¨æˆ·åˆ°Aç»„æˆ–Bç»„
                const group = Math.random() < 0.5 ? 'A' : 'B';
                
                // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œé€‰æ‹©
                sessionStorage.setItem('selectedCategory', category);
                sessionStorage.setItem('userGroup', group);
                
                // è®°å½•ç”¨æˆ·é€‰æ‹©
                UserInteractionSystem.logInteraction(category, 'category_select', {
                    group: group
                });

                console.log('User assigned to group:', group); // è°ƒè¯•ä¿¡æ¯
                
                // è·³è½¬åˆ°å¸–å­åˆ—è¡¨é¡µé¢
                window.location.href = 'posts.html';
            } catch (error) {
                console.error('Error in selectCategory:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            try {
                console.log('Initializing page...'); // è°ƒè¯•ä¿¡æ¯
                
                // ç”Ÿæˆç”¨æˆ·ID
                const userId = UserInteractionSystem.generateUserId();
                console.log('Generated userId:', userId); // è°ƒè¯•ä¿¡æ¯
                
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
                sessionStorage.removeItem('selectedCategory');
                sessionStorage.removeItem('userGroup');
                
                // è®°å½•é¡µé¢è®¿é—®
                UserInteractionSystem.logInteraction('index', 'page_view');
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        };
        // åœ¨é¡µé¢åŠ è½½æ—¶éšæœºåˆ†é…ç”¨æˆ·ç»„
         // æ£€æŸ¥æ˜¯å¦å·²åŒæ„
         if (!localStorage.getItem('consentGiven')) {
            document.getElementById('consentForm').style.display = 'flex';
        } else {
            document.getElementById('consentForm').style.display = 'none';
        }

        function agreeConsent() {
            localStorage.setItem('consentGiven', 'true');
            localStorage.setItem('consentTimestamp', new Date().toISOString());
            ExperimentSystem.logEvent('consent_given');
            document.getElementById('consentForm').style.display = 'none';
            ExperimentSystem.init();
        }

        function disagreeConsent() {
            window.location.href = 'about:blank';
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å®éªŒ
        function initializeExperiment() {
            // éšæœºåˆ†é…ç”¨æˆ·ç»„
            let userGroup = localStorage.getItem('userGroup');
            if (!userGroup) {
                userGroup = Math.random() < 0.5 ? 'A' : 'B';
                localStorage.setItem('userGroup', userGroup);
            }

            // åˆå§‹åŒ–äº¤äº’æ•°æ®æ”¶é›†
            let interactionData = {
                startTime: new Date().toISOString(),
                userGroup: userGroup,
                viewTime: 0,
                scrollDepth: 0,
                interactionCount: 0,
                engagementMetrics: {
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    timeSpentPerPost: 0,
                    scrollPause: 0
                }
            };
            localStorage.setItem('currentInteraction', JSON.stringify(interactionData));
        }

        // æ·»åŠ é€€å‡ºé—®å·ç›‘å¬
        window.addEventListener('beforeunload', function(e) {
            if(!localStorage.getItem('completedExitSurvey')) {
                showExitSurvey();
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // æ›´æ–°äº¤äº’æ•°æ®çš„å‡½æ•°
        function updateInteractionData(type, value) {
            let data = JSON.parse(localStorage.getItem('currentInteraction'));
            switch(type) {
                case 'viewTime':
                    data.viewTime += value;
                    break;
                case 'scroll':
                    data.scrollDepth = Math.max(data.scrollDepth, value);
                    break;
                case 'interaction':
                    data.interactionCount++;
                    break;
            }
            localStorage.setItem('currentInteraction', JSON.stringify(data));
        }

        // æ¯åˆ†é’Ÿæ›´æ–°æµè§ˆæ—¶é—´
        setInterval(() => {
            updateInteractionData('viewTime', 60);
        }, 60000);

        // ç›‘å¬æ»šåŠ¨
        window.addEventListener('scroll', function() {
            const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
            updateInteractionData('scroll', scrollPercent);
        });

        window.addEventListener('load', function() {
    // æ£€æŸ¥ç”¨æˆ·ç»„åˆ†é…
    let userGroup = localStorage.getItem('userGroup');
    if (!userGroup) {
        userGroup = Math.random() < 0.5 ? 'A' : 'B';
        localStorage.setItem('userGroup', userGroup);
    }

    // è·å–æ‰€æœ‰å¸–å­
    const allPosts = JSON.parse(localStorage.getItem('posts')) || {};
    
    // æ ¹æ®é…ç½®é€‰æ‹©è¦å±•ç¤ºçš„å¸–å­
    const selectedPosts = selectPostsForUser(userGroup, allPosts);
    
    // éšæœºæ‰“ä¹±å±•ç¤ºé¡ºåº
    const shuffledPosts = randomizePosts(selectedPosts);
    
    // å±•ç¤ºå¸–å­
    displayPosts(shuffledPosts);
});

function selectPostsForUser(group, allPosts) {
    const config = experimentConfig.content.groupSetup[group];
    let selectedPosts = [];
    
    if (group === 'A') {
        // Aç»„åªé€‰æ‹©äººå·¥ç‰ˆæœ¬
        selectedPosts = selectHumanPosts(allPosts, config.postsCount);
    } else {
        // Bç»„æ··åˆé€‰æ‹©
        const humanCount = Math.floor(config.postsCount * config.ratio.human);
        const aiCount = config.postsCount - humanCount;
        
        const humanPosts = selectHumanPosts(allPosts, humanCount);
        const aiPosts = selectAIPosts(allPosts, aiCount, humanPosts);
        
        selectedPosts = [...humanPosts, ...aiPosts];
    }
    
    return selectedPosts;
}

function selectHumanPosts(allPosts, count) {
    let humanPosts = [];
    // ä»æ¯ä¸ªåˆ†ç±»ä¸­é€‰æ‹©äººå·¥å¸–å­
    Object.values(allPosts).forEach(categoryPosts => {
        humanPosts = [...humanPosts, 
            ...categoryPosts.filter(post => post.version === 'human')];
    });
    
    // éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡
    return shuffleArray(humanPosts).slice(0, count);
}

function selectAIPosts(allPosts, count, selectedHumanPosts) {
    // é€‰æ‹©ä¸å·²é€‰äººå·¥å¸–å­å¯¹åº”çš„AIç‰ˆæœ¬
    const aiPosts = [];
    selectedHumanPosts.forEach(humanPost => {
        const aiVersion = findAIVersion(allPosts, humanPost.id);
        if (aiVersion) {
            aiPosts.push(aiVersion);
        }
    });
    
    return aiPosts;
}

function shuffleArray(array) {
    return array.sort(() => Math.random() - 0.5);
}
    </script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    const firebaseConfig = {
        // ...existing code...
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
    window.firestoreDB = {
        db,
        collection,
        doc,
        setDoc
    };

    const interactionsCollection = collection(db, 'interactions');
    
    // ä¿®æ”¹ç”¨æˆ·äº¤äº’ç³»ç»Ÿ
    UserInteractionSystem.logInteraction = async function(category, interactionType, details = {}) {
        const interaction = {
            userId: this.generateUserId(),
            userGroup: sessionStorage.getItem('userGroup'),
            category,
            interactionType,
            details,
            timestamp: new Date().toISOString()
        };

        try {
            await setDoc(doc(interactionsCollection), interaction);
        } catch (error) {
            console.error('ä¿å­˜äº¤äº’æ•°æ®å¤±è´¥:', error);
        }
    };
</script>
</body>
</html>

