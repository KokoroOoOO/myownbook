<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∏ñÂ≠êËØ¶ÊÉÖ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
        }
        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
        }
        .author-info {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .interaction-bar {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        .interaction-button {
            display: flex;
            align-items: center;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
        }
        .interaction-button.active {
            color: #ff2442;
        }
      
        .existing-comments {
        margin-bottom: 30px;
        }
        
        
    .reply-input-area {
        margin: 10px 0 10px 55px;
        display: none;
    }

    .reply-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 8px;
    }

    .replies-container {
        margin-left: 55px;
        border-left: 2px solid #f0f0f0;
        padding-left: 15px;
    }

    .reply-item {
        margin: 10px 0;
        padding: 8px;
        background: #f9f9f9;
        border-radius: 4px;
    }
    .comments-section {
    margin-top: 20px;
    padding: 20px;
}

.comment-input-area {
    margin: 20px 0;
}

.comment-input {
    width: 100%;
    min-height: 100px;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
}
.comment-item {
    background: #f8f8f8;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
}

.comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

.comment-author {
    font-weight: bold;
}

.comment-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    color: #666;
    font-size: 0.9em;
}

.comment-action-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
    transition: all 0.3s ease;
}


.comment-action-btn:hover {
    background: #f0f0f0;
}

.comment-action-btn.liked {
    color: #ff4757;
}

.comment-likes-count {
    margin-left: 5px;
}

.no-comments {
    text-align: center;
    color: #666;
    padding: 20px;
}
        .ai-check {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        .ai-check button {
    padding: 8px 15px;
    margin: 0 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.ai-check button.selected {
    background: #4CAF50;
    color: white;
    border-color: #4CAF50;
}

    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUp72tIZBypw-HgVVQWN88egtH4uyuL0",
            authDomain: "redbook-31e18.firebaseapp.com",
            projectId: "redbook-31e18",
            storageBucket: "redbook-31e18.firebasestorage.app",
            messagingSenderId: "568218518846",
            appId: "1:568218518846:web:aaa8eb53765749b856d86f",
            measurementId: "G-WGQS7TLVTT"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);
        
        window.db = db;
    </script>
</head>
<body>
    <div class="container">
        <div id="postContent"></div>
        <div class="interaction-bar">
            <button class="interaction-button" id="likeButton" onclick="toggleLike()">
                ‚ù§Ô∏è <span id="likeCount">0</span>
            </button>
            <button class="interaction-button" id="favoriteButton" onclick="toggleFavorite()">
                ‚≠ê <span id="favoriteCount">0</span>
            </button>
            <button class="interaction-button" onclick="focusComment()">
                üí¨ ËØÑËÆ∫
            </button>
        </div>
        <div class="ai-check">
            <p>‰Ω†ËÆ§‰∏∫ËøôÊòØAIÁîüÊàêÁöÑÂÜÖÂÆπÂêóÔºü</p>
            <button onclick="markAsAI(true)">ÊòØ</button>
            <button onclick="markAsAI(false)">Âê¶</button>
        </div>
        <div class="comments-section">
            <h3>ËØÑËÆ∫ (<span id="commentCount">0</span>)</h3>
    <div class="existing-comments" id="existingComments">
        <!-- Â∑≤ÊúâËØÑËÆ∫Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
    </div>
    <div class="comment-input-area">
        <textarea class="comment-input" id="commentInput" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑËØÑËÆ∫..."></textarea>
        <button onclick="submitComment()">ÂèëË°®ËØÑËÆ∫</button>
     </div>
            
    </div>

    <script>
        const UserInteractionSystem = {
    generateUserId: function() {
        if (!sessionStorage.getItem('userId')) {
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('userId', userId);
        }
        return sessionStorage.getItem('userId');
    },

    logInteraction: async function(postId, interactionType, details = {}) {
        try {
            if (!window.db) {
                console.error('Firebase not initialized');
                return;
            }

            const interaction = {
                userId: this.generateUserId(),
                userGroup: sessionStorage.getItem('userGroup'),
                postId,
                interactionType,
                details,
                timestamp: new Date().toISOString()
            };

            // ‰ΩøÁî® ref Âíå set Êõø‰ª£Áõ¥Êé•ËÆøÈóÆ
            const interactionRef = window.dbRef(window.db, `interactions/${Date.now()}`);
            await window.dbSet(interactionRef, interaction);
            
            // Êú¨Âú∞Â≠òÂÇ®
            let interactions = JSON.parse(localStorage.getItem('userInteractions')) || [];
            interactions.push(interaction);
            localStorage.setItem('userInteractions', JSON.stringify(interactions));
        } catch (error) {
            console.error('‰øùÂ≠ò‰∫§‰∫íÊï∞ÊçÆÂ§±Ë¥•:', error);
        }
    },

    hasInteracted: function(postId, interactionType) {
        const userId = this.generateUserId();
        const interactions = JSON.parse(localStorage.getItem('userInteractions')) || [];
        return interactions.some(i => 
            i.userId === userId && 
            i.postId === postId && 
            i.interactionType === interactionType
        );
    },

    removeInteraction: function(postId, interactionType) {
        const userId = this.generateUserId();
        let interactions = JSON.parse(localStorage.getItem('userInteractions')) || [];
        interactions = interactions.filter(i => 
            !(i.userId === userId && i.postId === postId && i.interactionType === interactionType)
        );
        localStorage.setItem('userInteractions', JSON.stringify(interactions));
    }
};
        let currentPost;
       

        function loadPost() {
    try {
        currentPost = JSON.parse(sessionStorage.getItem('currentPost'));
        console.log('Loading post:', currentPost); // Ë∞ÉËØï‰ø°ÊÅØ

        if (!currentPost) {
            console.error('No post data found in sessionStorage');
            return;
        }

        const postContent = document.getElementById('postContent');
        const imageUrl = validateImageUrl(currentPost.image);
        
        // Â§ÑÁêÜÊç¢Ë°åÊòæÁ§∫
        const displayContent = currentPost.content.replace(/<br>/g, '\n');
        
        postContent.innerHTML = `
            <img src="${imageUrl}" class="post-image" alt="Â∏ñÂ≠êÂõæÁâá" onerror="this.src='https://via.placeholder.com/400'">
            <div class="author-info">
                <img src="${currentPost.authorAvatar || 'https://via.placeholder.com/40'}" class="author-avatar" alt="‰ΩúËÄÖÂ§¥ÂÉè">
                <span>${currentPost.author || 'ÂåøÂêçÁî®Êà∑'}</span>
            </div>
            <h1>${currentPost.title || 'Êó†Ê†áÈ¢ò'}</h1>
            <p style="white-space: pre-line;">${displayContent}</p>
        `;

        // Êõ¥Êñ∞ÁÇπËµûÂíåÊî∂ËóèÊï∞
        document.getElementById('likeCount').textContent = currentPost.likes || 0;
        document.getElementById('favoriteCount').textContent = currentPost.favorites || 0;

        // Âä†ËΩΩËØÑËÆ∫
        loadExistingComments();
    } catch (error) {
        console.error('Error loading post:', error);
    }
}

// Ê∑ªÂä†ÂõæÁâáURLÈ™åËØÅÂáΩÊï∞
function validateImageUrl(url) {
    if(!url) return 'https://via.placeholder.com/400';
    if(url.startsWith('/')) {
        return window.location.origin + url;
    }
    if(url.startsWith('//')) {
        return 'https:' + url;
    }
    if(!url.startsWith('http')) {
        return 'https://' + url;
    }
    return url;
}

    

    function loadExistingComments() {
        const commentsContainer = document.getElementById('existingComments');
        const commentCount = document.getElementById('commentCount');
        
        if (currentPost.comments && currentPost.comments.length > 0) {
            commentCount.textContent = currentPost.comments.length;
            commentsContainer.innerHTML = currentPost.comments.map(comment => `
                <div class="comment-item" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <img src="${comment.avatar}" class="comment-avatar" alt="ËØÑËÆ∫ËÄÖÂ§¥ÂÉè">
                        <span class="comment-author">${comment.author}</span>
                    </div>
                    <div class="comment-content">
                        <p>${comment.content}</p>
                        <div class="comment-meta">
                            <span>${formatDate(comment.timestamp)}</span>
                            <div class="comment-actions">
                                <button class="comment-action-btn ${comment.userLiked ? 'liked' : ''}" 
                                        onclick="toggleCommentLike(${comment.id})">
                                    ‚ù§Ô∏è <span class="comment-likes-count">${comment.likes || 0}</span>
                                </button>
                                <button class="comment-action-btn" onclick="showReplyInput(${comment.id})">
                                    üí¨ ÂõûÂ§ç
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="reply-input-area" id="replyInput-${comment.id}">
                        <textarea class="reply-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÂõûÂ§ç..."></textarea>
                        <button onclick="submitReply(${comment.id})">ÂèëÈÄÅ</button>
                    </div>
                    <div class="replies-container" id="replies-${comment.id}">
                        ${(comment.replies || []).map(reply => createReplyHTML(reply)).join('')}
                    </div>
                </div>
            `).join('');
        } else {
            commentCount.textContent = '0';
            commentsContainer.innerHTML = '<p class="no-comments">ÊöÇÊó†ËØÑËÆ∫</p>';
        }
    }

    function createReplyHTML(reply) {
        return `
            <div class="reply-item" data-reply-id="${reply.id}">
                <div class="comment-header">
                    <img src="${reply.avatar}" class="comment-avatar" alt="ÂõûÂ§çËÄÖÂ§¥ÂÉè">
                    <span class="comment-author">${reply.author}</span>
                </div>
                <div class="comment-content">
                    <p>${reply.content}</p>
                    <div class="comment-meta">
                        <span>${formatDate(reply.timestamp)}</span>
                        <button class="comment-action-btn ${reply.userLiked ? 'liked' : ''}" 
                                onclick="toggleCommentLike(${reply.id})">
                            ‚ù§Ô∏è <span class="comment-likes-count">${reply.likes || 0}</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function showReplyInput(commentId) {
        const replyInputArea = document.getElementById(`replyInput-${commentId}`);
        if (!replyInputArea) return;
        
        // ÈöêËóèÂÖ∂‰ªñÊâÄÊúâÂõûÂ§çÊ°Ü
        document.querySelectorAll('.reply-input-area').forEach(el => {
            if (el !== replyInputArea) {
                el.style.display = 'none';
            }
        });
        
        // ÂàáÊç¢ÂΩìÂâçÂõûÂ§çÊ°ÜÁöÑÊòæÁ§∫Áä∂ÊÄÅ
        replyInputArea.style.display = replyInputArea.style.display === 'block' ? 'none' : 'block';
    }

    function submitReply(commentId) {
        const replyInputArea = document.getElementById(`replyInput-${commentId}`);
        const replyText = replyInputArea.querySelector('textarea').value.trim();
        
        if (!replyText) {
            alert('ËØ∑ËæìÂÖ•ÂõûÂ§çÂÜÖÂÆπÔºÅ');
            return;
        }

        const newReply = {
            id: Date.now(),
            author: 'ËÆøÂÆ¢Áî®Êà∑',
            avatar: 'https://via.placeholder.com/40',
            content: replyText,
            likes: 0,
            userLiked: false,
            timestamp: new Date().toISOString()
        };

        // Êü•ÊâæÂπ∂Êõ¥Êñ∞ËØÑËÆ∫
        const comment = currentPost.comments.find(c => c.id === commentId);
        if (comment) {
            if (!comment.replies) comment.replies = [];
            comment.replies.push(newReply);

            // Êõ¥Êñ∞Â≠òÂÇ®
            saveCurrentPost();

            // Êõ¥Êñ∞ÊòæÁ§∫
            const repliesContainer = document.getElementById(`replies-${commentId}`);
            repliesContainer.insertAdjacentHTML('beforeend', createReplyHTML(newReply));

            // Ê∏ÖÁ©∫Âπ∂ÈöêËóèËæìÂÖ•Ê°Ü
            replyInputArea.querySelector('textarea').value = '';
            replyInputArea.style.display = 'none';
        }
    }

    function toggleCommentLike(id) {
        // Êü•ÊâæËØÑËÆ∫ÊàñÂõûÂ§ç
        let item = findCommentOrReply(id);
        if (!item) return;

        // Êõ¥Êñ∞ÁÇπËµûÁä∂ÊÄÅ
        item.userLiked = !item.userLiked;
        item.likes = item.userLiked ? (item.likes || 0) + 1 : Math.max(0, (item.likes || 0) - 1);

        // Êõ¥Êñ∞UI
        const likeButton = document.querySelector(`[data-comment-id="${id}"] .comment-action-btn, [data-reply-id="${id}"] .comment-action-btn`);
        const likesCount = likeButton.querySelector('.comment-likes-count');
        
        likeButton.classList.toggle('liked', item.userLiked);
        likesCount.textContent = item.likes;

        // ‰øùÂ≠òÊõ¥Êîπ
        saveCurrentPost();
    }

    function findCommentOrReply(id) {
        // ÂÖàÂú®ËØÑËÆ∫‰∏≠Êü•Êâæ
        let item = currentPost.comments.find(c => c.id === id);
        if (item) return item;

        // Âú®ÂõûÂ§ç‰∏≠Êü•Êâæ
        for (let comment of currentPost.comments) {
            if (comment.replies) {
                item = comment.replies.find(r => r.id === id);
                if (item) return item;
            }
        }
        return null;
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    function createCommentHTML(comment, isReply = false) {
        return `
            <div class="comment-item" data-comment-id="${comment.id}">
                <img src="${comment.avatar}" class="comment-avatar" alt="ËØÑËÆ∫ËÄÖÂ§¥ÂÉè">
                <div class="comment-content">
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-text">${comment.content}</div>
                    <div class="comment-meta">
                        <span>${formatDate(comment.timestamp)}</span>
                    </div>
                    <div class="comment-actions">
                        <button class="comment-action-btn ${comment.userLiked ? 'liked' : ''}" 
                                onclick="toggleCommentLike(${comment.id})">
                            ‚ù§Ô∏è <span class="comment-likes-count">${comment.likes || 0}</span>
                        </button>
                        ${!isReply ? `
                            <button class="comment-action-btn" onclick="showReplyInput(${comment.id})">
                                üí¨ ÂõûÂ§ç
                            </button>
                        ` : ''}
                    </div>
                    ${!isReply ? `
                        <div class="reply-input-area" id="replyInput-${comment.id}">
                            <textarea class="reply-input" placeholder="ÂÜô‰∏ã‰Ω†ÁöÑÂõûÂ§ç..."></textarea>
                            <button onclick="submitReply(${comment.id})">ÂèëÈÄÅ</button>
                        </div>
                        <div class="replies-container" id="replies-${comment.id}">
                            ${(comment.replies || []).map(reply => createCommentHTML(reply, true)).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    // Êèê‰∫§Êñ∞ËØÑËÆ∫
    function submitComment() {
    try {
        const commentInput = document.getElementById('commentInput');
        const content = commentInput.value.trim();
        
        if (!content) {
            alert('ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπÔºÅ');
            return;
        }

        // ËÆ∞ÂΩï‰∫§‰∫í
        UserInteractionSystem.logInteraction(currentPost.id, 'comment', {
            text: content
        });

        // ÂàõÂª∫Êñ∞ËØÑËÆ∫
        const newComment = {
            id: Date.now(),
            author: 'ËÆøÂÆ¢Áî®Êà∑',
            avatar: 'https://via.placeholder.com/40',
            content: content,
            likes: 0,
            userLiked: false,
            timestamp: new Date().toISOString()
        };

        // Êõ¥Êñ∞ËØÑËÆ∫ÂàóË°®
        if (!currentPost.comments) {
            currentPost.comments = [];
        }
        currentPost.comments.push(newComment);

        // Êõ¥Êñ∞Â≠òÂÇ®
        const category = sessionStorage.getItem('selectedCategory');
        let posts = JSON.parse(localStorage.getItem('posts'));
        if (posts && category) {
            const postIndex = posts[category].findIndex(post => post.id === currentPost.id);
            if (postIndex !== -1) {
                posts[category][postIndex] = currentPost;
                localStorage.setItem('posts', JSON.stringify(posts));
                sessionStorage.setItem('currentPost', JSON.stringify(currentPost));
            }
        }

        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂ÈáçÊñ∞Âä†ËΩΩËØÑËÆ∫
        commentInput.value = '';
        loadExistingComments();
        
        alert('ËØÑËÆ∫ÂèëË°®ÊàêÂäüÔºÅ');
    } catch (error) {
        console.error('Error submitting comment:', error);
        alert('ËØÑËÆ∫ÂèëË°®Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
    }
}


function toggleLike() {
    const likeButton = document.getElementById('likeButton');
    const likeCount = document.getElementById('likeCount');
    const hasLiked = UserInteractionSystem.hasInteracted(currentPost.id, 'like');
    
    if (hasLiked) {
        // ÂèñÊ∂àÁÇπËµû
        UserInteractionSystem.removeInteraction(currentPost.id, 'like');
        likeButton.classList.remove('active');
        likeCount.textContent = Math.max(0, parseInt(likeCount.textContent) - 1);
    } else {
        // Ê∑ªÂä†ÁÇπËµû
        UserInteractionSystem.logInteraction(currentPost.id, 'like');
        likeButton.classList.add('active');
        likeCount.textContent = parseInt(likeCount.textContent) + 1;
    }
}

function toggleFavorite() {
    const favoriteButton = document.getElementById('favoriteButton');
    const favoriteCount = document.getElementById('favoriteCount');
    const hasFavorited = UserInteractionSystem.hasInteracted(currentPost.id, 'favorite');
    
    if (hasFavorited) {
        // ÂèñÊ∂àÊî∂Ëóè
        UserInteractionSystem.removeInteraction(currentPost.id, 'favorite');
        favoriteButton.classList.remove('active');
        favoriteCount.textContent = Math.max(0, parseInt(favoriteCount.textContent) - 1);
    } else {
        // Ê∑ªÂä†Êî∂Ëóè
        UserInteractionSystem.logInteraction(currentPost.id, 'favorite');
        favoriteButton.classList.add('active');
        favoriteCount.textContent = parseInt(favoriteCount.textContent) + 1;
    }
}

function updateCommentCount() {
    const commentCount = document.getElementById('commentCount');
    if (currentPost.comments) {
        commentCount.textContent = currentPost.comments.length;
    } else {
        commentCount.textContent = '0';
    }
}


function markAsAI(isAI) {
    UserInteractionSystem.logInteraction(currentPost.id, 'ai_check', { isAI: isAI });
    
    // Êõ¥Êñ∞ AI Âà§Êñ≠ÊåâÈíÆÁöÑËßÜËßâÊïàÊûú
    const aiButtons = document.querySelectorAll('.ai-check button');
    aiButtons.forEach(button => {
        const isYesButton = button.getAttribute('onclick') === 'markAsAI(true)';
        if ((isYesButton && isAI) || (!isYesButton && !isAI)) {
            button.classList.add('selected');
        } else {
            button.classList.remove('selected');
        }
    });
    
    alert('ÊÑüË∞¢‰Ω†ÁöÑÂèçÈ¶àÔºÅ');
}



        function focusComment() {
            document.getElementById('commentInput').focus();
        }

        function toggleCommentLike(commentId) {
    let comment = findComment(commentId);
    if (!comment) return;

    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
    if (!commentElement) return;

    const likeButton = commentElement.querySelector('.comment-action-btn');
    const likesCount = commentElement.querySelector('.comment-likes-count');
    
    if (!comment.userLiked) {
        comment.userLiked = true;
        comment.likes = (comment.likes || 0) + 1;
        likeButton.classList.add('liked');
    } else {
        comment.userLiked = false;
        comment.likes = Math.max(0, (comment.likes || 0) - 1);
        likeButton.classList.remove('liked');
    }
    
    likesCount.textContent = comment.likes;

    // Êõ¥Êñ∞Â≠òÂÇ®
    saveCurrentPost();
}

function saveCurrentPost() {
    // ‰∏çÂÜçÁõ¥Êé•‰øÆÊîπÂ∏ñÂ≠êÊï∞ÊçÆ
    const interactionData = {
        postId: currentPost.id,
        userId: UserInteractionSystem.generateUserId(),
        timestamp: new Date().toISOString(),
        likes: parseInt(document.getElementById('likeCount').textContent),
        favorites: parseInt(document.getElementById('favoriteCount').textContent),
        comments: currentPost.comments
    };

    // Â≠òÂÇ®‰∫§‰∫íÊï∞ÊçÆ
    let interactions = JSON.parse(localStorage.getItem('postInteractions')) || [];
    interactions.push(interactionData);
    localStorage.setItem('postInteractions', JSON.stringify(interactions));
}

function checkForUpdates() {
    const updates = JSON.parse(localStorage.getItem('postUpdates')) || {};
    const lastCheck = localStorage.getItem('lastUpdateCheck') || '0';
    
    for (let postId in updates) {
        if (updates[postId] > lastCheck) {
            loadPost(); // ÈáçÊñ∞Âä†ËΩΩÂ∏ñÂ≠êÊï∞ÊçÆ
            break;
        }
    }
    
    localStorage.setItem('lastUpdateCheck', new Date().toISOString());
}

// ÂÆöÊúüÊ£ÄÊü•Êõ¥Êñ∞
setInterval(checkForUpdates, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

// Ëé∑ÂèñÂΩìÂâçÂ∏ñÂ≠êÁöÑ‰ºöËØùÁªüËÆ°Êï∞ÊçÆ
function getPostSessionStats(postId) {
    const interactions = JSON.parse(localStorage.getItem('userInteractions')) || [];
    const postInteractions = interactions.filter(i => i.postId === postId);
    
    return {
        likes: new Set(postInteractions.filter(i => i.interactionType === 'like').map(i => i.userId)).size,
        favorites: new Set(postInteractions.filter(i => i.interactionType === 'favorite').map(i => i.userId)).size,
        comments: postInteractions.filter(i => i.interactionType === 'comment').length
    };
}
// Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÁöÑ‰∫§‰∫íÁä∂ÊÄÅ
function getCurrentUserInteractions(postId) {
    const userId = sessionStorage.getItem('userId');
    const interactions = JSON.parse(localStorage.getItem('userInteractions')) || [];
    return {
        hasLiked: interactions.some(i => i.userId === userId && i.postId === postId && i.interactionType === 'like'),
        hasFavorited: interactions.some(i => i.userId === userId && i.postId === postId && i.interactionType === 'favorite')
    };
}

// Â§ÑÁêÜÁÇπËµû
function handleLike(postId) {
    const userStatus = getCurrentUserInteractions(postId);
    if (!userStatus.hasLiked) {
        UserInteractionSystem.logInteraction(postId, 'like');
        updatePostStats();
    }
}

// Â§ÑÁêÜÊî∂Ëóè
function handleFavorite(postId) {
    const userStatus = getCurrentUserInteractions(postId);
    if (!userStatus.hasFavorited) {
        UserInteractionSystem.logInteraction(postId, 'favorite');
        updatePostStats();
    }
}

// Â§ÑÁêÜËØÑËÆ∫
function handleComment(postId, commentText) {
    if (commentText.trim()) {
        UserInteractionSystem.logInteraction(postId, 'comment', {
            text: commentText
        });
        updatePostStats();
        // Ê∏ÖÁ©∫ËØÑËÆ∫ËæìÂÖ•Ê°Ü
        document.getElementById('commentInput').value = '';
    }
}

// Êõ¥Êñ∞Â∏ñÂ≠êÁªüËÆ°Êï∞ÊçÆÊòæÁ§∫
function updatePostStats() {
    const post = JSON.parse(sessionStorage.getItem('currentPost'));
    const stats = getPostSessionStats(post.id);
    const userStatus = getCurrentUserInteractions(post.id);

    // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
    document.getElementById('likeCount').textContent = stats.likes;
    document.getElementById('favoriteCount').textContent = stats.favorites;
    document.getElementById('commentCount').textContent = stats.comments;

    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    document.getElementById('likeButton').classList.toggle('active', userStatus.hasLiked);
    document.getElementById('favoriteButton').classList.toggle('active', userStatus.hasFavorited);
}
// Á°Æ‰øù Firebase ÂàùÂßãÂåñÂÆåÊàêÂêéÂÜçÊâßË°å
window.onload = function() {
    const checkFirebase = setInterval(() => {
        if (window.db) {
            clearInterval(checkFirebase);
            loadPost();
            
            const post = JSON.parse(sessionStorage.getItem('currentPost'));
            if (post) {
                UserInteractionSystem.logInteraction(post.id, 'view_detail');
            }
        }
    }, 100);
};


    </script>
</body>
</html>
