<!DOCTYPE html>
<html lang="zh">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹ç®¡ç†</title>
    <script src="experiment-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script src="firestore-helper.js"></script>
    <style>
        body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        height: 100vh;
        overflow-y: auto;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .post-form, .export-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .user-group-info {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        text-align: center;
    }

    .group-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
    }

    .A-badge {
        background-color: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .B-badge {
        background-color: #fce4ec;
        color: #c2185b;
        border: 1px solid #f8bbd0;
    }

    .both-badge {
        background-color: #f1f8e9;
        color: #558b2f;
        border: 1px solid #dcedc8;
    }

    .post-meta {
        margin: 10px 0;
        display: flex;
        align-items: center;
    }

    .group-A {
        border-left: 4px solid #1976d2;
    }

    .group-B {
        border-left: 4px solid #c2185b;
    }

    .group-both {
        border-left: 4px solid #558b2f;
    }

    .form-group {
        margin-bottom: 20px;
        width: 100%;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-group small {
        display: block;
        color: #666;
        margin-top: 5px;
        font-size: 12px;
    }

    .btn-primary, .button {
        background-color: #007bff;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .btn-primary:hover, .button:hover {
        background-color: #0056b3;
    }

    .post-actions button {
        margin-right: 10px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .comments-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .author-name {
        font-weight: bold;
    }

    .delete-button {
        background: #ff4444;
        margin-left: 10px;
    }

    .comment-input-group {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .remove-comment {
        background-color: #ff4444;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #imagePreview img,
    #avatarPreview img {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 4px;
    }

    #avatarPreview img {
        border-radius: 50%;
        width: 100px;
        height: 100px;
        object-fit: cover;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-content {
        position: relative;
        background-color: white;
        margin: 30px auto;
        padding: 20px;
        width: 80%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: calc(100vh - 60px);
        overflow-y: auto;
    }

    .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #666;
    }

    .close:hover {
        color: #333;
    }

    .edit-button {
        background: #4a90e2;
    }

    .posts-list {
        margin-top: 30px;
    }

    .post-item {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .preview-container {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .post-media img {
        max-width: 200px;
        height: auto;
        border-radius: 4px;
    }

    .post-info {
        flex: 1;
    }

    .post-title {
        margin: 0 0 10px 0;
        color: #333;
    }

    .post-stats {
        display: flex;
        gap: 15px;
        color: #666;
        margin: 10px 0;
    }

    .post-stats span {
        background: #f0f0f0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .comment-input-group {
        background: #f9f9f9;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .comment-input-group input,
    .comment-input-group textarea {
        width: calc(100% - 20px);
        margin-bottom: 10px;
        padding: 8px;
    }

    .comment-input-group textarea {
        min-height: 60px;
    }

    .comment-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        resize: vertical;
        min-height: 60px;
    }

    .comment-button {
        background-color: #4CAF50;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .comment-button:hover {
        background-color: #45a049;
    }

    #editCommentsContainer {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
    }

    .edit-form-container {
        padding: 20px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
    }

    #editCommentsContainer h3 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .stat-button {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 20px;
        transition: all 0.2s;
    }

    .stat-button:hover {
        background-color: #f0f0f0;
    }

    .stat-button.active {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .interaction-stats {
        display: flex;
        gap: 20px;
        margin: 15px 0;
    }

    .comments-section {
        margin-top: 20px;
        padding: 15px;
        border-top: 1px solid #ddd;
    }

    .add-comment {
        margin-bottom: 20px;
    }

    .add-comment textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
    }

    .comment-item {
        display: flex;
        justify-content: space-between;
        align-items: start;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .comment-content {
        flex-grow: 1;
    }

    .comment-content p {
        margin: 0 0 5px 0;
    }

    .comment-content small {
        color: #666;
    }

    .delete-btn {
        padding: 4px 8px;
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .delete-btn:hover {
        background-color: #cc0000;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
            margin: 10px auto;
            max-height: calc(100vh - 20px);
        }

        .preview-container {
            flex-direction: column;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <select id="contentVersion" required>
            <option value="human">äººå·¥ç‰ˆæœ¬</option>
            <option value="ai">AIç‰ˆæœ¬</option>
        </select>
        
        <select id="category" required>
            <option value="food">ç¾é£Ÿ</option>
            <option value="pets">å® ç‰©</option>
            <option value="beauty">ç¾å¦†</option>
            <option value="travel">æ—…æ¸¸</option>
        </select>
    
        <input type="number" id="wordCount" placeholder="å­—æ•°" required>
        <h1>å†…å®¹ç®¡ç†ç³»ç»Ÿ</h1>
        <a href="analytics.html" style="display: inline-block; margin-bottom: 20px; padding: 8px 16px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;">æŸ¥çœ‹æ•°æ®åˆ†æ</a>
        <div class="data-controls" style="margin-bottom: 20px;">
            <button onclick="exportData()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">å¯¼å‡ºå¸–å­æ•°æ®</button>
            
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this.files[0])">
            <button onclick="document.getElementById('importFile').click()" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">å¯¼å…¥å¸–å­æ•°æ®</button>
        </div>
        <div class="post-form">
            <h2>æ·»åŠ æ–°å¸–å­</h2>
            <form id="postForm">
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select name="category" required>
                        <option value="food">ç¾é£Ÿ</option>
                        <option value="pets">èŒå® </option>
                        <option value="beauty">ç¾å¦†</option>
                        <option value="travel">æ—…æ¸¸</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" name="title" required placeholder="è¯·è¾“å…¥æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>è¯¦ç»†å†…å®¹</label>
                    <textarea name="content" required></textarea>
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡URL</label>
                    <input type="text" name="image" required placeholder="è¯·è¾“å…¥å›¾ç‰‡é“¾æ¥æˆ–ä½¿ç”¨é»˜è®¤å›¾ç‰‡">
    <small>å¦‚ä¸å¡«å†™å°†ä½¿ç”¨é»˜è®¤å›¾ç‰‡</small>
                </div>
                <div class="form-group">
                    <label>ä½œè€…</label>
                    <input type="text" name="author" required placeholder="è¯·è¾“å…¥ä½œè€…åç§°">
                </div>
                <div class="form-group">
                    <label>ä½œè€…å¤´åƒURL</label>
                    <input type="text" name="authorAvatar" placeholder="è¯·è¾“å…¥ä½œè€…å¤´åƒé“¾æ¥æˆ–ä½¿ç”¨é»˜è®¤å¤´åƒ">
    <small>å¦‚ä¸å¡«å†™å°†ä½¿ç”¨é»˜è®¤å¤´åƒ</small>
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡é¢„è§ˆ</label>
                    <div id="imagePreview"></div>
                </div>
                <div class="form-group">
                    <label>ä½œè€…å¤´åƒé¢„è§ˆ</label>
                    <div id="avatarPreview"></div>
                </div>      
                <div class="form-group">
                    <label>åˆå§‹ç‚¹èµæ•°</label>
                    <input type="number" name="likes" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>åˆå§‹æ”¶è—æ•°</label>
                    <input type="number" name="favorites" value="0" min="0">
                </div>          
                <div class="form-group">
                    <label>é¢„è®¾è¯„è®º</label>
                    <div id="commentsContainer">
                        <div class="comment-input-group">
                            <input type="text" name="commentAuthor[]" placeholder="è¯„è®ºè€…åç§°">
                            <input type="text" name="commentAvatar[]" placeholder="è¯„è®ºè€…å¤´åƒURL">
                            <textarea name="commentContent[]" placeholder="è¯„è®ºå†…å®¹"></textarea>
                            <input type="number" name="commentLikes[]" placeholder="ç‚¹èµæ•°">
                            <button type="button" class="remove-comment">åˆ é™¤</button>
                        </div>
                    </div>
                    <button type="button" class="button" onclick="addCommentField()">æ·»åŠ è¯„è®º</button>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="isAI">
                        æ˜¯å¦ä¸ºAIç”Ÿæˆå†…å®¹
                    </label>
                    <input type="text" id="originalPostId" placeholder="åŸæ–‡ID(AIç‰ˆæœ¬å¿…å¡«)">
                </div>
                <!-- åœ¨ç®¡ç†ç«¯çš„è¡¨å•ä¸­æ·»åŠ ç»„åˆ«é€‰æ‹© -->
<div class="form-group">
    <label for="group">æ˜¾ç¤ºç»„åˆ«</label>
    <select id="group" name="group" required>
        <option value="A">Aç»„</option>
        <option value="B">Bç»„</option>
        <option value="both">ä¸¤ç»„éƒ½æ˜¾ç¤º</option>
    </select>
    <small>é€‰æ‹©è¯¥å¸–å­å°†æ˜¾ç¤ºç»™å“ªä¸ªç»„çš„ç”¨æˆ·</small>
</div>

                <button type="submit" class="button">æ·»åŠ å¸–å­</button>
            </form>
        </div>
            <h2>å¸–å­ç®¡ç†</h2>
            <div id="postsList">
                <!-- å¸–å­åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <div id="editForm">
            <!-- ç¼–è¾‘è¡¨å•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

        <div id="editModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>ç¼–è¾‘å¸–å­</h2>
                <form id="editForm">
                    <input type="hidden" name="postId">
                    <input type="hidden" name="category">
                    
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>é¢„è§ˆå†…å®¹</label>
                        <textarea name="preview" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>è¯¦ç»†å†…å®¹</label>
                        <textarea name="content" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>å›¾ç‰‡URL</label>
                        <input type="text" name="image" required>
                    </div>
                    <div class="form-group">
                        <label>ä½œè€…</label>
                        <input type="text" name="author" required>
                    </div>
                    <div class="form-group">
                        <label>ä½œè€…å¤´åƒURL</label>
                        <input type="text" name="authorAvatar" required>
                    </div>
                    <div class="form-group">
                        <label>ç‚¹èµæ•°</label>
                        <input type="number" name="likes" min="0">
                    </div>
                    <div class="form-group">
                        <label>æ”¶è—æ•°</label>
                        <input type="number" name="favorites" min="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="isAI">
                            æ˜¯å¦ä¸ºAIç”Ÿæˆå†…å®¹
                        </label>
                    </div>
                    
                    <div id="editCommentsContainer">
                        <h3>è¯„è®º</h3>
                        <!-- è¯„è®ºå°†åœ¨JavaScriptä¸­åŠ¨æ€æ·»åŠ  -->
                    </div>
                    <button type="button" class="button" onclick="addCommentFieldToEdit()">
                        æ·»åŠ è¯„è®º
                    </button>
                    
                    <button type="submit" class="button">ä¿å­˜æ›´æ”¹</button>
                </form>
            </div>
        </div>
    </div>
    <div class="export-section">
        <h3>æ•°æ®å¯¼å‡º</h3>
        <button onclick="exportFullReport()">å¯¼å‡ºå®Œæ•´æŠ¥å‘Š</button>
        <button onclick="exportRawData()">å¯¼å‡ºåŸå§‹æ•°æ®</button>
    </div>

    <script>
        // åœ¨è¿™é‡Œå£°æ˜å…¨å±€å˜é‡
    let currentEditingCategory = null;
    let currentEditingId = null;
    
    // ç¡®ä¿ posts å˜é‡åœ¨å…¨å±€èŒƒå›´å†…å®šä¹‰
    let posts = JSON.parse(localStorage.getItem('posts')) || {
        food: [],
        pets: [],
        beauty: [],
        travel: []
    };
        // ç®€å•çš„å¯†ç ä¿æŠ¤
if (!localStorage.getItem('adminAuth')) {
    const password = prompt('è¯·è¾“å…¥ç®¡ç†å¯†ç :');
    if (password !== 'asdfghjkl') { // è®¾ç½®ä½ çš„å¯†ç 
        alert('å¯†ç é”™è¯¯');
        window.location.href = 'index.html';
    } else {
        localStorage.setItem('adminAuth', 'true');
    }
}

function exportData() {
    const posts = localStorage.getItem('posts');
    const blob = new Blob([posts], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'posts.json';
    a.click();
}

// æ·»åŠ å¯¼å…¥åŠŸèƒ½
function importData(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        localStorage.setItem('posts', e.target.result);
        location.reload();
    };
    reader.readAsText(file);
}
        const styles = `
    .group-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
    }

    .A-badge {
        background-color: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .B-badge {
        background-color: #fce4ec;
        color: #c2185b;
        border: 1px solid #f8bbd0;
    }

    .both-badge {
        background-color: #f1f8e9;
        color: #558b2f;
        border: 1px solid #dcedc8;
    }

    .post-meta {
        margin: 10px 0;
        display: flex;
        align-items: center;
    }

    .group-A {
        border-left: 4px solid #1976d2;
    }

    .group-B {
        border-left: 4px solid #c2185b;
    }

    .group-both {
        border-left: 4px solid #558b2f;
    }

    .post-item {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .preview-container {
        display: flex;
        gap: 20px;
    }

    .post-info {
        flex: 1;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .post-stats {
        display: flex;
        gap: 15px;
        margin: 10px 0;
        color: #666;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .edit-button {
        background: #4CAF50;
        color: white;
    }

    .delete-button {
        background: #f44336;
        color: white;
    }
`;
        const styleSheet = document.createElement("style");
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('close')) {
        closeEditModal();
    }
    if (e.target.classList.contains('modal')) {
        closeEditModal();
    }
});
        function initializeEventListeners() {
    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
    const form = document.getElementById('postForm');
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
    document.querySelector('input[name="image"]').addEventListener('input', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = e.target.value ? 
            `<img src="${e.target.value}" alt="é¢„è§ˆå›¾ç‰‡">` : '';
            
    });

    document.querySelector('input[name="authorAvatar"]').addEventListener('input', function(e) {
        const preview = document.getElementById('avatarPreview');
        preview.innerHTML = e.target.value ? 
            `<img src="${e.target.value}" alt="å¤´åƒé¢„è§ˆ">` : '';
    });
      // è¡¨å•æäº¤å¤„ç†
      document.getElementById('postForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // æ”¶é›†è¯„è®ºæ•°æ®
        const comments = [];
        const authors = formData.getAll('commentAuthor[]');
        const avatars = formData.getAll('commentAvatar[]');
        const contents = formData.getAll('commentContent[]');
        const commentLikes = formData.getAll('commentLikes[]');
        
        for (let i = 0; i < authors.length; i++) {
            if (authors[i] && contents[i]) {
                comments.push({
                    author: authors[i],
                    avatar: avatars[i] || 'https://via.placeholder.com/40',
                    content: contents[i],
                    likes: parseInt(commentLikes[i]) || 0,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // åˆ›å»ºæ–°å¸–å­å¯¹è±¡
        const newPost = {
            id: Date.now().toString(), // æ”¹ä¸ºå­—ç¬¦ä¸²ç±»å‹
            title: formData.get('title') || 'æ— æ ‡é¢˜',
            preview: formData.get('content').substring(0, 100) + '...',
            content: formData.get('content') || 'æ— å†…å®¹',
            image: formData.get('image') || 'https://via.placeholder.com/400',
            author: formData.get('author') || 'åŒ¿åç”¨æˆ·',
            authorAvatar: formData.get('authorAvatar') || 'https://via.placeholder.com/40',
            isAI: formData.get('isAI') === 'on',
            isAIGenerated: formData.get('isAI') === 'on', // æ·»åŠ è¿™ä¸ªå­—æ®µ
            likes: parseInt(formData.get('likes')) || 0,
            favorites: parseInt(formData.get('favorites')) || 0,
            comments: comments,
            timestamp: new Date().toISOString()
        };

        const category = formData.get('category');

        // ç¡®ä¿ posts å¯¹è±¡å­˜åœ¨
        if (!posts[category]) {
            posts[category] = [];
        }
        
        // æ·»åŠ æ–°å¸–å­
        posts[category].push(newPost);
        
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('posts', JSON.stringify(posts));
        
        // æ›´æ–°æ˜¾ç¤º
        displayPosts();
        
        // é‡ç½®è¡¨å•
        this.reset();
        
        // æ¸…ç©ºé¢„è§ˆ
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('avatarPreview').innerHTML = '';
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        alert('å¸–å­æ·»åŠ æˆåŠŸï¼');
    });
}
function savePosts() {
    try {
        const posts = JSON.parse(localStorage.getItem('posts')) || {};
        // ... ä¿å­˜æ“ä½œ
        localStorage.setItem('posts', JSON.stringify(posts));
        return true;
    } catch (error) {
        console.error('ä¿å­˜å¸–å­æ—¶å‡ºé”™:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        return false;
    }
}

        // åˆ é™¤å¸–å­å‡½æ•°
function deletePost(category, postId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡å¸–å­å—ï¼Ÿ')) {
        const posts = JSON.parse(localStorage.getItem('posts')) || {};
        
        if (posts[category]) {
            posts[category] = posts[category].filter(p => p.id.toString() !== postId.toString());
            
            // å¦‚æœè¯¥åˆ†ç±»ä¸‹æ²¡æœ‰å¸–å­äº†ï¼Œåˆ é™¤è¯¥åˆ†ç±»
            if (posts[category].length === 0) {
                delete posts[category];
            }
            
            localStorage.setItem('posts', JSON.stringify(posts));
            
            // åŒæ—¶åˆ é™¤è¯¥å¸–å­çš„è¯„è®º
            let comments = JSON.parse(localStorage.getItem('comments')) || {};
            delete comments[postId];
            localStorage.setItem('comments', JSON.stringify(comments));
            
            displayPosts();
        }
    }
}

        

function getCategoryName(category) {
    const categoryNames = {
        food: 'ç¾é£Ÿ',
        pets: 'èŒå® ',
        beauty: 'ç¾å¦†',
        travel: 'æ—…æ¸¸'
    };
    return categoryNames[category] || category;
}

        
    // æ·»åŠ è¯„è®ºå­—æ®µçš„å‡½æ•°
function addCommentField() {
    const container = document.getElementById('commentsContainer');
    const commentGroup = document.createElement('div');
    commentGroup.className = 'comment-input-group';
    commentGroup.innerHTML = `
        <input type="text" name="commentAuthor[]" placeholder="è¯„è®ºè€…åç§°">
        <input type="text" name="commentAvatar[]" placeholder="è¯„è®ºè€…å¤´åƒURL">
        <textarea name="commentContent[]" placeholder="è¯„è®ºå†…å®¹"></textarea>
        <input type="number" name="commentLikes[]" placeholder="ç‚¹èµæ•°">
        <button type="button" class="remove-comment">åˆ é™¤</button>
    `;
    container.appendChild(commentGroup);
}

// åˆ é™¤è¯„è®ºå­—æ®µ
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-comment')) {
        e.target.parentElement.remove();
    }
});

// ä¿®æ”¹è¡¨å•æäº¤å¤„ç†
document.getElementById('postForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // æ”¶é›†è¯„è®ºæ•°æ®
    const comments = [];
    const authors = formData.getAll('commentAuthor[]');
    const avatars = formData.getAll('commentAvatar[]');
    const contents = formData.getAll('commentContent[]');
    const commentLikes = formData.getAll('commentLikes[]');
    
    for (let i = 0; i < authors.length; i++) {
        if (authors[i] && contents[i]) {
            comments.push({
                author: authors[i],
                avatar: avatars[i] || 'https://via.placeholder.com/40',
                content: contents[i],
                likes: parseInt(commentLikes[i]) || 0,
                timestamp: new Date().toISOString()
            });
        }
    }

    const newPost = {
        id: Date.now().toString(),
        title: formData.get('title'),
        content: formData.get('content'),
        image: formData.get('image') || 'https://via.placeholder.com/400',
        author: formData.get('author'),
        authorAvatar: formData.get('authorAvatar') || 'https://via.placeholder.com/40',
        isAI: formData.get('isAI') === 'on',
        isAIGenerated: formData.get('isAI') === 'on', // æ·»åŠ è¿™ä¸ªå­—æ®µ
        group: formData.get('group'),
        likes: parseInt(formData.get('likes')) || 0,
        favorites: parseInt(formData.get('favorites')) || 0,
        comments: comments,
        timestamp: new Date().toISOString()
    };

    const category = formData.get('category');
    
    // è·å–ç°æœ‰å¸–å­æ•°æ®
    let posts = JSON.parse(localStorage.getItem('posts')) || {};
    
    // ç¡®ä¿åˆ†ç±»å­˜åœ¨
    if (!posts[category]) {
        posts[category] = [];
    }
    
    // æ·»åŠ æ–°å¸–å­
    posts[category].push(newPost);
    
    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('posts', JSON.stringify(posts));
    
    // æ›´æ–°æ˜¾ç¤º
    displayPosts();
    
    // é‡ç½®è¡¨å•å’Œé¢„è§ˆ
    this.reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('avatarPreview').innerHTML = '';
    
    alert('å¸–å­æ·»åŠ æˆåŠŸï¼');
});

// æ›´æ–°æ˜¾ç¤ºå¸–å­çš„å‡½æ•°
function displayPosts() {
    const posts = JSON.parse(localStorage.getItem('posts')) || {};
    let postsHtml = '';
    
    Object.entries(posts).forEach(([category, categoryPosts]) => {
        if (categoryPosts && categoryPosts.length > 0) {
            postsHtml += `<h3>${getCategoryName(category)}</h3>`;
            categoryPosts.forEach(post => {
                let groupClass = post.group ? `group-${post.group.toLowerCase()}` : '';
                let groupBadge = post.group ? 
                    `<span class="${post.group.toLowerCase()}-badge">${getGroupLabel(post.group)}</span>` : '';
                
                postsHtml += `
                    <div class="post-item ${groupClass}">
                        <div class="post-meta">
                            ${groupBadge}
                            ${post.isAI ? '<span class="badge">AIç”Ÿæˆ</span>' : ''}
                        </div>
                        <div class="preview-container">
                            <div class="post-media">
                                <img src="${post.image || 'https://via.placeholder.com/400'}" alt="å¸–å­å›¾ç‰‡">
                            </div>
                            <div class="post-info">
                                <div class="author-info">
                                    <img src="${post.authorAvatar || 'https://via.placeholder.com/40'}" 
                                         alt="ä½œè€…å¤´åƒ" 
                                         style="width: 40px; height: 40px; border-radius: 50%;">
                                    <span class="author-name">${post.author || 'åŒ¿åç”¨æˆ·'}</span>
                                </div>
                                <h4 class="post-title">${post.title}</h4>
                                <p>${post.content ? post.content.substring(0, 100) + '...' : ''}</p>
                                <div class="post-stats">
                                    <span>ğŸ‘ ${post.likes || 0}</span>
                                    <span>â­ ${post.favorites || 0}</span>
                                    <span>ğŸ’¬ ${(post.comments || []).length}</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button onclick="editPost('${category}', '${post.id}')" class="edit-button">ç¼–è¾‘</button>
                            <button onclick="deletePost('${category}', '${post.id}')" class="delete-button">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
        }
    });
    
    if (!postsHtml) {
        postsHtml = '<p>æš‚æ— å¸–å­</p>';
    }
    
    document.getElementById('postsList').innerHTML = postsHtml;
}

// å°†å¸–å­HTMLæ¨¡æ¿æŠ½å–ä¸ºç‹¬ç«‹å‡½æ•°
function createPostHTML(post, category) {
    return `
        <div class="post-item ${post.group ? `group-${post.group}` : ''}">
            <div class="preview-container">
                <div class="post-media">
                    <img src="${post.image || 'https://via.placeholder.com/400'}" alt="å¸–å­å›¾ç‰‡">
                </div>
                <div class="post-info">
                    <div class="author-info">
                        <img src="${post.authorAvatar || 'https://via.placeholder.com/40'}" 
                             alt="ä½œè€…å¤´åƒ" 
                             style="width: 40px; height: 40px; border-radius: 50%;">
                        <span class="author-name">${post.author || 'åŒ¿åç”¨æˆ·'}</span>
                    </div>
                    <h4 class="post-title">${post.title}</h4>
                    <p>${post.content.substring(0, 100)}...</p>
                    <div class="post-stats">
                        <span>ğŸ‘ ${post.likes || 0}</span>
                        <span>â­ ${post.favorites || 0}</span>
                        <span>ğŸ’¬ ${(post.comments || []).length}</span>
                    </div>
                </div>
            </div>
            <div class="post-actions">
                <button onclick="editPost('${category}', '${post.id.toString()}')" class="edit-button">ç¼–è¾‘</button>
                <button onclick="deletePost('${category}', '${post.id.toString()}')" class="delete-button">åˆ é™¤</button>
            </div>
        </div>
    `;
}

function displayComments(postId) {
    let comments = JSON.parse(localStorage.getItem('comments')) || {};
    let postComments = comments[postId] || [];
    let commentsHtml = '';
    
    postComments.forEach((comment, index) => {
        commentsHtml += `
            <div class="comment">
                <p>${comment.content}</p>
                <small>è¯„è®ºæ—¶é—´: ${new Date(comment.timestamp).toLocaleString()}</small>
                <button onclick="deleteComment('${postId}', ${index})">åˆ é™¤è¯„è®º</button>
            </div>
        `;
    });
    
    document.getElementById('comments').innerHTML = commentsHtml;
}
function deleteComment(postId, commentIndex) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
        let comments = JSON.parse(localStorage.getItem('comments')) || {};
        
        // ç¡®ä¿è¯¥å¸–å­çš„è¯„è®ºæ•°ç»„å­˜åœ¨
        if (comments[postId]) {
            // åˆ é™¤æŒ‡å®šç´¢å¼•çš„è¯„è®º
            comments[postId].splice(commentIndex, 1);
            
            // å¦‚æœè¯¥å¸–å­æ²¡æœ‰è¯„è®ºäº†ï¼Œåˆ é™¤è¯¥å¸–å­çš„è¯„è®ºé”®
            if (comments[postId].length === 0) {
                delete comments[postId];
            }
            
            // ä¿å­˜æ›´æ–°åçš„è¯„è®º
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // é‡æ–°æ˜¾ç¤ºè¯„è®º
            displayComments(postId);
        }
    }
}
// è¾…åŠ©å‡½æ•°ï¼šè·å–ç»„åˆ«æ˜¾ç¤ºæ ‡ç­¾
function getGroupLabel(group) {
    switch(group) {
        case 'A':
            return 'Aç»„å†…å®¹';
        case 'B':
            return 'Bç»„å†…å®¹';
        default:
            return 'æ‰€æœ‰ç”¨æˆ·å¯è§';
    }
}

// æŸ¥çœ‹è¯„è®ºçš„å‡½æ•°
function viewComments(postId) {
    let post;
    for (let category in posts) {
        post = posts[category].find(p => p.id === postId);
        if (post) break;
    }
    
    if (post) {
        const comments = post.comments.map(comment => `
            <div style="border-bottom: 1px solid #eee; padding: 10px;">
                <img src="${comment.avatar}" alt="è¯„è®ºè€…å¤´åƒ" style="width: 30px; height: 30px; border-radius: 50%;">
                <strong>${comment.author}</strong>
                <p>${comment.content}</p>
                <small>ç‚¹èµæ•°: ${comment.likes}</small>
            </div>
        `).join('');
        
        alert(`è¯„è®ºåˆ—è¡¨ï¼š\n${comments}`);
    }
}
function editPost(category, postId) {
    const posts = JSON.parse(localStorage.getItem('posts')) || {};
    const post = posts[category]?.find(p => p.id.toString() === postId.toString());
    
    if (!post) {
        alert('æ‰¾ä¸åˆ°è¯¥å¸–å­ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
        return;
    }

    // åˆ›å»ºç¼–è¾‘è¡¨å•
    const editForm = `
        <div class="modal" style="display: block;">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <form id="editPostForm" class="edit-form-container">
                    <input type="hidden" name="postId" value="${post.id}">
                    
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" name="title" class="form-control" value="${post.title || ''}" required>
                    </div>

                    <div class="form-group">
                        <label>è¯¦ç»†å†…å®¹</label>
                        <textarea name="content" class="form-control" required>${post.content || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>å›¾ç‰‡URL</label>
                        <input type="text" name="image" class="form-control" value="${post.image || ''}" required>
                        <div id="imagePreview">
                            ${post.image ? `<img src="${post.image}" alt="é¢„è§ˆå›¾ç‰‡">` : ''}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ä½œè€…</label>
                        <input type="text" name="author" class="form-control" value="${post.author || ''}" required>
                    </div>

                    <div class="form-group">
                        <label>ä½œè€…å¤´åƒURL</label>
                        <input type="text" name="authorAvatar" class="form-control" value="${post.authorAvatar || ''}">
                        <div id="avatarPreview">
                            ${post.authorAvatar ? `<img src="${post.authorAvatar}" alt="å¤´åƒé¢„è§ˆ">` : ''}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>åˆ†ç±»</label>
                        <select name="category" class="form-control">
                            <option value="food" ${category === 'food' ? 'selected' : ''}>ç¾é£Ÿ</option>
                            <option value="pets" ${category === 'pets' ? 'selected' : ''}>èŒå® </option>
                            <option value="beauty" ${category === 'beauty' ? 'selected' : ''}>ç¾å¦†</option>
                            <option value="travel" ${category === 'travel' ? 'selected' : ''}>æ—…æ¸¸</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>æ˜¾ç¤ºç»„åˆ«</label>
                        <select name="group" class="form-control" required>
                            <option value="A" ${post.group === 'A' ? 'selected' : ''}>Aç»„</option>
                            <option value="B" ${post.group === 'B' ? 'selected' : ''}>Bç»„</option>
                            <option value="both" ${post.group === 'both' ? 'selected' : ''}>ä¸¤ç»„éƒ½æ˜¾ç¤º</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="isAI" ${post.isAI ? 'checked' : ''}>
                            æ˜¯å¦ä¸ºAIç”Ÿæˆå†…å®¹
                        </label>
                    </div>

                    <div class="form-group">
                        <label>ç‚¹èµæ•°</label>
                        <input type="number" name="likes" class="form-control" value="${post.likes || 0}" min="0">
                    </div>

                    <div class="form-group">
                        <label>æ”¶è—æ•°</label>
                        <input type="number" name="favorites" class="form-control" value="${post.favorites || 0}" min="0">
                    </div>

                    <div class="form-group">
                        <h3>è¯„è®ºç®¡ç†</h3>
                        <div id="editCommentsContainer">
                            ${(post.comments || []).map((comment, index) => `
                                <div class="comment-input-group">
                                    <input type="text" name="commentAuthor[]" value="${comment.author || ''}" placeholder="è¯„è®ºè€…åç§°">
                                    <input type="text" name="commentAvatar[]" value="${comment.avatar || ''}" placeholder="è¯„è®ºè€…å¤´åƒURL">
                                    <textarea name="commentContent[]" placeholder="è¯„è®ºå†…å®¹">${comment.content || ''}</textarea>
                                    <input type="number" name="commentLikes[]" value="${comment.likes || 0}" placeholder="ç‚¹èµæ•°">
                                    <button type="button" class="remove-comment" onclick="removeComment(this)">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="button" onclick="addCommentFieldToEdit()">æ·»åŠ è¯„è®º</button>
                    </div>

                    <button type="submit" class="button">ä¿å­˜æ›´æ”¹</button>
                </form>
            </div>
        </div>
    `;

    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ¨¡æ€æ¡†
    const oldModal = document.querySelector('.modal');
    if (oldModal) {
        oldModal.remove();
    }

    // æ·»åŠ æ–°çš„ç¼–è¾‘è¡¨å•åˆ°é¡µé¢
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = editForm;
    document.body.appendChild(modalContainer);

    // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶ç›‘å¬
    const form = modalContainer.querySelector('form');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (await saveEdit(category, postId, this)) {
            closeEditModal();
        }
    });

    // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶ç›‘å¬
    modalContainer.querySelector('.close').addEventListener('click', function(e) {
        e.preventDefault();
        closeEditModal();
    });

    // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
    modalContainer.addEventListener('click', function(e) {
        if (e.target === modalContainer) {
            closeEditModal();
        }
    });
}
function removeComment(button) {
    button.closest('.comment-input-group').remove();
}

// æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨
function displayComments(postId) {
    let comments = JSON.parse(localStorage.getItem('comments')) || {};
    let postComments = comments[postId] || [];
    
    let commentsHtml = '';
    if (postComments.length === 0) {
        commentsHtml = '<p>æš‚æ— è¯„è®º</p>';
    } else {
        postComments.forEach((comment, index) => {
            commentsHtml += `
                <div class="comment-item">
                    <div class="comment-content">
                        <p>${comment.content}</p>
                        <small>${new Date(comment.timestamp).toLocaleString()}</small>
                    </div>
                    <button onclick="deleteComment('${postId}', ${index})" class="delete-btn">
                        åˆ é™¤
                    </button>
                </div>
            `;
        });
    }
    
    document.getElementById('commentsList').innerHTML = commentsHtml;
}

// æ·»åŠ æ–°è¯„è®º
function addComment(postId) {
    let content = document.getElementById('newComment').value.trim();
    if (!content) {
        alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
    }
    
    let comments = JSON.parse(localStorage.getItem('comments')) || {};
    if (!comments[postId]) {
        comments[postId] = [];
    }
    
    // æ·»åŠ æ–°è¯„è®º
    comments[postId].push({
        content: content,
        timestamp: new Date().toISOString()
    });
    
    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('comments', JSON.stringify(comments));
    
    // æ¸…ç©ºè¾“å…¥æ¡†å¹¶åˆ·æ–°æ˜¾ç¤º
    document.getElementById('newComment').value = '';
    displayComments(postId);
}

// åˆ é™¤è¯„è®º
function deleteComment(postId, commentIndex) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
        let comments = JSON.parse(localStorage.getItem('comments')) || {};
        
        if (comments[postId]) {
            comments[postId].splice(commentIndex, 1);
            if (comments[postId].length === 0) {
                delete comments[postId];
            }
            localStorage.setItem('comments', JSON.stringify(comments));
            displayComments(postId);
        }
    }
}

// æ›´æ–°å¸–å­çš„å‡½æ•°
function updatePost(originalCategory, postId) {
    const updatedPost = {
        id: postId,
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value,
        image: document.getElementById('editImage').value,
        author: document.getElementById('editAuthor').value,
        authorAvatar: document.getElementById('editAuthorAvatar').value,
        group: document.getElementById('editGroup').value, // æ·»åŠ ç»„åˆ«
        // ä¿æŒåŸæœ‰çš„ç»Ÿè®¡æ•°æ®
        likes: posts[originalCategory].find(p => p.id === postId).likes || 0,
        favorites: posts[originalCategory].find(p => p.id === postId).favorites || 0,
        comments: posts[originalCategory].find(p => p.id === postId).comments || []
    };

    const newCategory = document.getElementById('editCategory').value;

    // ä»åŸåˆ†ç±»ä¸­åˆ é™¤
    posts[originalCategory] = posts[originalCategory].filter(p => p.id !== postId);

    // æ·»åŠ åˆ°æ–°åˆ†ç±»
    if (!posts[newCategory]) {
        posts[newCategory] = [];
    }
    posts[newCategory].push(updatedPost);

    // ä¿å­˜åˆ° localStorage
    localStorage.setItem('posts', JSON.stringify(posts));

    // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°æ˜¾ç¤º
    closeEditModal();
    displayPosts();
}

// å…³é—­æ¨¡æ€æ¡†
function closeEditModal() {
    // æ‰¾åˆ°å¹¶ç§»é™¤åŠ¨æ€åˆ›å»ºçš„æ¨¡æ€æ¡†
    const dynamicModal = document.querySelector('.modal');
    if (dynamicModal) {
        dynamicModal.remove();
    }
}

    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('editModal').style.display = 'none';

// å…³é—­æ¨¡æ€æ¡†çš„åŠŸèƒ½
document.querySelector('.close').onclick = function() {
    document.getElementById('editModal').style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}


function addCommentFieldToEdit() {
    const container = document.getElementById('editCommentsContainer');
    const commentGroup = document.createElement('div');
    commentGroup.className = 'comment-input-group';
    commentGroup.innerHTML = `
        <input type="text" name="commentAuthor[]" placeholder="è¯„è®ºè€…åç§°">
        <input type="text" name="commentAvatar[]" placeholder="è¯„è®ºè€…å¤´åƒURL">
        <textarea name="commentContent[]" placeholder="è¯„è®ºå†…å®¹"></textarea>
        <input type="number" name="commentLikes[]" value="0" placeholder="ç‚¹èµæ•°">
        <button type="button" class="remove-comment">åˆ é™¤è¯„è®º</button>
    `;
    container.appendChild(commentGroup);
}



// å¯¼å‡ºæ•°æ®çš„æŒ‰é’®ä»£ç 
function exportPosts() {
    const dataStr = JSON.stringify(posts, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'posts-data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// æ˜¾ç¤ºå¸–å­ç®¡ç†ç•Œé¢
function showPosts() {
    document.getElementById('postsList').style.display = 'block';
    document.getElementById('analyticsContainer').style.display = 'none';
    document.getElementById('postForm').style.display = 'block';
    displayPosts(); // åŸæœ‰çš„æ˜¾ç¤ºå¸–å­å‡½æ•°
}
function exportFullReport() {
        const report = {
            experimentInfo: getExperimentInfo(),
            interactionData: getAllInteractions(),
            analysis: analyzeHypothesis()
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], 
            {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'experiment_report.json';
        a.click();
    }

    function getExperimentInfo() {
        return {
            startDate: localStorage.getItem('experimentStartDate'),
            totalParticipants: getTotalParticipants(),
            groupDistribution: getGroupDistribution()
        };
    }
    

function validatePost(postData) {
    const config = experimentConfig.controls;
    
    // æ£€æŸ¥å­—æ•°
    const wordCount = postData.content.length;
    if (wordCount < config.contentLength.min || 
        wordCount > config.contentLength.max) {
        alert(`å­—æ•°å¿…é¡»åœ¨${config.contentLength.min}-${config.contentLength.max}ä¹‹é—´`);
        return false;
    }

    // AIç‰ˆæœ¬å¿…é¡»å¡«å†™åŸæ–‡ID
    if (postData.version === 'ai' && !postData.originalPostId) {
        alert('AIç‰ˆæœ¬å¿…é¡»å¡«å†™å¯¹åº”çš„åŸæ–‡ID');
        return false;
    }

    return true;
}
// ä¿å­˜ç¼–è¾‘çš„å‡½æ•°
async function saveEdit(category, postId, form) {
    try {
        const posts = JSON.parse(localStorage.getItem('posts')) || {};
        const formData = new FormData(form);
        
        const updatedPost = {
            id: postId.toString(),
            title: formData.get('title'),
            content: formData.get('content'),
            image: formData.get('image'),
            author: formData.get('author'),
            authorAvatar: formData.get('authorAvatar'),
            // ç¡®ä¿ç»„åˆ«ä¿¡æ¯è¢«æ­£ç¡®ä¿å­˜
            group: formData.get('group'),
            isAI: formData.get('isAI') === 'on',
            isAIGenerated: formData.get('isAI') === 'on', // æ·»åŠ è¿™ä¸ªå­—æ®µ
            likes: parseInt(formData.get('likes')) || 0,
            favorites: parseInt(formData.get('favorites')) || 0,
            contentA: posts[category].find(p => p.id.toString() === postId.toString()).contentA,
            contentB: posts[category].find(p => p.id.toString() === postId.toString()).contentB,
            comments: [], // åˆå§‹åŒ–è¯„è®ºæ•°ç»„
            timestamp: new Date().toISOString()
        };

        // æ”¶é›†è¯„è®ºæ•°æ®
        const authors = formData.getAll('commentAuthor[]');
        const avatars = formData.getAll('commentAvatar[]');
        const contents = formData.getAll('commentContent[]');
        const commentLikes = formData.getAll('commentLikes[]');
        
        for (let i = 0; i < authors.length; i++) {
            if (authors[i] && contents[i]) {
                updatedPost.comments.push({
                    author: authors[i],
                    avatar: avatars[i] || 'https://via.placeholder.com/40',
                    content: contents[i],
                    likes: parseInt(commentLikes[i]) || 0,
                    timestamp: new Date().toISOString()
                });
            }
        }

        const newCategory = formData.get('category');
        
        // ä»åŸåˆ†ç±»ä¸­åˆ é™¤
        posts[category] = posts[category].filter(p => p.id.toString() !== postId.toString());
        
        // ç¡®ä¿æ–°åˆ†ç±»å­˜åœ¨
        if (!posts[newCategory]) {
            posts[newCategory] = [];
        }
        
        // æ·»åŠ åˆ°æ–°åˆ†ç±»
        posts[newCategory].push(updatedPost);
        
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('posts', JSON.stringify(posts));
        
        // è°ƒè¯•è¾“å‡º
        console.log('Saved post:', updatedPost);
        console.log('Updated posts:', posts);
        
        // åˆ·æ–°æ˜¾ç¤º
        displayPosts();
        
        alert('ä¿å­˜æˆåŠŸï¼');
        return true;
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        return false;
    }
}

// æ·»åŠ é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
window.onload = function() {
    // åˆå§‹åŒ–æ•°æ®ç»“æ„
    if (!localStorage.getItem('posts')) {
        localStorage.setItem('posts', JSON.stringify({
            food: [],
            pets: [],
            beauty: [],
            travel: []
        }));
    }
    
    initializeEventListeners();
    displayPosts();
    
    // ç¡®ä¿ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§æ¨¡æ€æ¡†
    const oldModal = document.querySelector('.modal');
    if (oldModal) {
        oldModal.remove();
    }
};
</script>
</body>
</html>
