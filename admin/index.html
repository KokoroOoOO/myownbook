<!DOCTYPE html>
<html lang="zh">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容管理</title>
    <script src="experiment-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    <script src="firestore-helper.js"></script>
    <style>
        body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        height: 100vh;
        overflow-y: auto;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .post-form, .export-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .user-group-info {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        text-align: center;
    }

    .group-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
    }

    .A-badge {
        background-color: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .B-badge {
        background-color: #fce4ec;
        color: #c2185b;
        border: 1px solid #f8bbd0;
    }

    .both-badge {
        background-color: #f1f8e9;
        color: #558b2f;
        border: 1px solid #dcedc8;
    }

    .post-meta {
        margin: 10px 0;
        display: flex;
        align-items: center;
    }

    .group-A {
        border-left: 4px solid #1976d2;
    }

    .group-B {
        border-left: 4px solid #c2185b;
    }

    .group-both {
        border-left: 4px solid #558b2f;
    }

    .form-group {
        margin-bottom: 20px;
        width: 100%;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .form-group small {
        display: block;
        color: #666;
        margin-top: 5px;
        font-size: 12px;
    }

    .btn-primary, .button {
        background-color: #007bff;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .btn-primary:hover, .button:hover {
        background-color: #0056b3;
    }

    .post-actions button {
        margin-right: 10px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .comments-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .author-name {
        font-weight: bold;
    }

    .delete-button {
        background: #ff4444;
        margin-left: 10px;
    }

    .comment-input-group {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .remove-comment {
        background-color: #ff4444;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    #imagePreview img,
    #avatarPreview img {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 4px;
    }

    #avatarPreview img {
        border-radius: 50%;
        width: 100px;
        height: 100px;
        object-fit: cover;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-content {
        position: relative;
        background-color: white;
        margin: 30px auto;
        padding: 20px;
        width: 80%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: calc(100vh - 60px);
        overflow-y: auto;
    }

    .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #666;
    }

    .close:hover {
        color: #333;
    }

    .edit-button {
        background: #4a90e2;
    }

    .posts-list {
        margin-top: 30px;
    }

    .post-item {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .preview-container {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .post-media img {
        max-width: 200px;
        height: auto;
        border-radius: 4px;
    }

    .post-info {
        flex: 1;
    }

    .post-title {
        margin: 0 0 10px 0;
        color: #333;
    }

    .post-stats {
        display: flex;
        gap: 15px;
        color: #666;
        margin: 10px 0;
    }

    .post-stats span {
        background: #f0f0f0;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .comment-input-group {
        background: #f9f9f9;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .comment-input-group input,
    .comment-input-group textarea {
        width: calc(100% - 20px);
        margin-bottom: 10px;
        padding: 8px;
    }

    .comment-input-group textarea {
        min-height: 60px;
    }

    .comment-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        resize: vertical;
        min-height: 60px;
    }

    .comment-button {
        background-color: #4CAF50;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .comment-button:hover {
        background-color: #45a049;
    }

    #editCommentsContainer {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        max-height: 400px;
        overflow-y: auto;
    }

    .edit-form-container {
        padding: 20px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
    }

    #editCommentsContainer h3 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .stat-button {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        border: none;
        background: none;
        cursor: pointer;
        border-radius: 20px;
        transition: all 0.2s;
    }

    .stat-button:hover {
        background-color: #f0f0f0;
    }

    .stat-button.active {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .interaction-stats {
        display: flex;
        gap: 20px;
        margin: 15px 0;
    }

    .comments-section {
        margin-top: 20px;
        padding: 15px;
        border-top: 1px solid #ddd;
    }

    .add-comment {
        margin-bottom: 20px;
    }

    .add-comment textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
    }

    .comment-item {
        display: flex;
        justify-content: space-between;
        align-items: start;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #eee;
        border-radius: 4px;
    }

    .comment-content {
        flex-grow: 1;
    }

    .comment-content p {
        margin: 0 0 5px 0;
    }

    .comment-content small {
        color: #666;
    }

    .delete-btn {
        padding: 4px 8px;
        background-color: #ff4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .delete-btn:hover {
        background-color: #cc0000;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
            margin: 10px auto;
            max-height: calc(100vh - 20px);
        }

        .preview-container {
            flex-direction: column;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <select id="contentVersion" required>
            <option value="human">人工版本</option>
            <option value="ai">AI版本</option>
        </select>
        
        <select id="category" required>
            <option value="food">美食</option>
            <option value="pets">宠物</option>
            <option value="beauty">美妆</option>
            <option value="travel">旅游</option>
        </select>
    
        <input type="number" id="wordCount" placeholder="字数" required>
        <h1>内容管理系统</h1>
        <a href="analytics.html" style="display: inline-block; margin-bottom: 20px; padding: 8px 16px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;">查看数据分析</a>
        <div class="data-controls" style="margin-bottom: 20px;">
            <button onclick="exportData()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; margin-right: 10px; cursor: pointer;">导出帖子数据</button>
            
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this.files[0])">
            <button onclick="document.getElementById('importFile').click()" style="padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">导入帖子数据</button>
        </div>
        <div class="post-form">
            <h2>添加新帖子</h2>
            <form id="postForm">
                <div class="form-group">
                    <label>分类</label>
                    <select name="category" required>
                        <option value="food">美食</option>
                        <option value="pets">萌宠</option>
                        <option value="beauty">美妆</option>
                        <option value="travel">旅游</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" name="title" required placeholder="请输入标题">
                </div>
                <div class="form-group">
                    <label>详细内容</label>
                    <textarea name="content" required></textarea>
                </div>
                <div class="form-group">
                    <label>图片URL</label>
                    <input type="text" name="image" required placeholder="请输入图片链接或使用默认图片">
    <small>如不填写将使用默认图片</small>
                </div>
                <div class="form-group">
                    <label>作者</label>
                    <input type="text" name="author" required placeholder="请输入作者名称">
                </div>
                <div class="form-group">
                    <label>作者头像URL</label>
                    <input type="text" name="authorAvatar" placeholder="请输入作者头像链接或使用默认头像">
    <small>如不填写将使用默认头像</small>
                </div>
                <div class="form-group">
                    <label>图片预览</label>
                    <div id="imagePreview"></div>
                </div>
                <div class="form-group">
                    <label>作者头像预览</label>
                    <div id="avatarPreview"></div>
                </div>      
                <div class="form-group">
                    <label>初始点赞数</label>
                    <input type="number" name="likes" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>初始收藏数</label>
                    <input type="number" name="favorites" value="0" min="0">
                </div>          
                <div class="form-group">
                    <label>预设评论</label>
                    <div id="commentsContainer">
                        <div class="comment-input-group">
                            <input type="text" name="commentAuthor[]" placeholder="评论者名称">
                            <input type="text" name="commentAvatar[]" placeholder="评论者头像URL">
                            <textarea name="commentContent[]" placeholder="评论内容"></textarea>
                            <input type="number" name="commentLikes[]" placeholder="点赞数">
                            <button type="button" class="remove-comment">删除</button>
                        </div>
                    </div>
                    <button type="button" class="button" onclick="addCommentField()">添加评论</button>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="isAI">
                        是否为AI生成内容
                    </label>
                    <input type="text" id="originalPostId" placeholder="原文ID(AI版本必填)">
                </div>
                <!-- 在管理端的表单中添加组别选择 -->
<div class="form-group">
    <label for="group">显示组别</label>
    <select id="group" name="group" required>
        <option value="A">A组</option>
        <option value="B">B组</option>
        <option value="both">两组都显示</option>
    </select>
    <small>选择该帖子将显示给哪个组的用户</small>
</div>

                <button type="submit" class="button">添加帖子</button>
            </form>
        </div>
            <h2>帖子管理</h2>
            <div id="postsList">
                <!-- 帖子列表将在这里显示 -->
        </div>
        <div id="editForm">
            <!-- 编辑表单将在这里显示 -->
        </div>
    </div>

        <div id="editModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>编辑帖子</h2>
                <form id="editForm">
                    <input type="hidden" name="postId">
                    <input type="hidden" name="category">
                    
                    <div class="form-group">
                        <label>标题</label>
                        <input type="text" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>预览内容</label>
                        <textarea name="preview" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>详细内容</label>
                        <textarea name="content" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>图片URL</label>
                        <input type="text" name="image" required>
                    </div>
                    <div class="form-group">
                        <label>作者</label>
                        <input type="text" name="author" required>
                    </div>
                    <div class="form-group">
                        <label>作者头像URL</label>
                        <input type="text" name="authorAvatar" required>
                    </div>
                    <div class="form-group">
                        <label>点赞数</label>
                        <input type="number" name="likes" min="0">
                    </div>
                    <div class="form-group">
                        <label>收藏数</label>
                        <input type="number" name="favorites" min="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="isAI">
                            是否为AI生成内容
                        </label>
                    </div>
                    
                    <div id="editCommentsContainer">
                        <h3>评论</h3>
                        <!-- 评论将在JavaScript中动态添加 -->
                    </div>
                    <button type="button" class="button" onclick="addCommentFieldToEdit()">
                        添加评论
                    </button>
                    
                    <button type="submit" class="button">保存更改</button>
                </form>
            </div>
        </div>
    </div>
    <div class="export-section">
        <h3>数据导出</h3>
        <button onclick="exportFullReport()">导出完整报告</button>
        <button onclick="exportRawData()">导出原始数据</button>
    </div>

    <script>
        // 在这里声明全局变量
    let currentEditingCategory = null;
    let currentEditingId = null;
    
    // 确保 posts 变量在全局范围内定义
    let posts = JSON.parse(localStorage.getItem('posts')) || {
        food: [],
        pets: [],
        beauty: [],
        travel: []
    };
        // 简单的密码保护
if (!localStorage.getItem('adminAuth')) {
    const password = prompt('请输入管理密码:');
    if (password !== 'asdfghjkl') { // 设置你的密码
        alert('密码错误');
        window.location.href = 'index.html';
    } else {
        localStorage.setItem('adminAuth', 'true');
    }
}

function exportData() {
    const posts = localStorage.getItem('posts');
    const blob = new Blob([posts], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'posts.json';
    a.click();
}

// 添加导入功能
function importData(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        localStorage.setItem('posts', e.target.result);
        location.reload();
    };
    reader.readAsText(file);
}
        const styles = `
    .group-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 10px;
    }

    .A-badge {
        background-color: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }

    .B-badge {
        background-color: #fce4ec;
        color: #c2185b;
        border: 1px solid #f8bbd0;
    }

    .both-badge {
        background-color: #f1f8e9;
        color: #558b2f;
        border: 1px solid #dcedc8;
    }

    .post-meta {
        margin: 10px 0;
        display: flex;
        align-items: center;
    }

    .group-A {
        border-left: 4px solid #1976d2;
    }

    .group-B {
        border-left: 4px solid #c2185b;
    }

    .group-both {
        border-left: 4px solid #558b2f;
    }

    .post-item {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .preview-container {
        display: flex;
        gap: 20px;
    }

    .post-info {
        flex: 1;
    }

    .author-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .post-stats {
        display: flex;
        gap: 15px;
        margin: 10px 0;
        color: #666;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .edit-button {
        background: #4CAF50;
        color: white;
    }

    .delete-button {
        background: #f44336;
        color: white;
    }
`;
        const styleSheet = document.createElement("style");
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('close')) {
        closeEditModal();
    }
    if (e.target.classList.contains('modal')) {
        closeEditModal();
    }
});
        function initializeEventListeners() {
    // 移除旧的事件监听器
    const form = document.getElementById('postForm');
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // 图片预览功能
    document.querySelector('input[name="image"]').addEventListener('input', function(e) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = e.target.value ? 
            `<img src="${e.target.value}" alt="预览图片">` : '';
            
    });

    document.querySelector('input[name="authorAvatar"]').addEventListener('input', function(e) {
        const preview = document.getElementById('avatarPreview');
        preview.innerHTML = e.target.value ? 
            `<img src="${e.target.value}" alt="头像预览">` : '';
    });
      // 表单提交处理
      document.getElementById('postForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // 收集评论数据
        const comments = [];
        const authors = formData.getAll('commentAuthor[]');
        const avatars = formData.getAll('commentAvatar[]');
        const contents = formData.getAll('commentContent[]');
        const commentLikes = formData.getAll('commentLikes[]');
        
        for (let i = 0; i < authors.length; i++) {
            if (authors[i] && contents[i]) {
                comments.push({
                    author: authors[i],
                    avatar: avatars[i] || 'https://via.placeholder.com/40',
                    content: contents[i],
                    likes: parseInt(commentLikes[i]) || 0,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // 创建新帖子对象
        const newPost = {
            id: Date.now().toString(), // 改为字符串类型
            title: formData.get('title') || '无标题',
            preview: formData.get('content').substring(0, 100) + '...',
            content: formData.get('content') || '无内容',
            image: formData.get('image') || 'https://via.placeholder.com/400',
            author: formData.get('author') || '匿名用户',
            authorAvatar: formData.get('authorAvatar') || 'https://via.placeholder.com/40',
            isAI: formData.get('isAI') === 'on',
            isAIGenerated: formData.get('isAI') === 'on', // 添加这个字段
            likes: parseInt(formData.get('likes')) || 0,
            favorites: parseInt(formData.get('favorites')) || 0,
            comments: comments,
            timestamp: new Date().toISOString()
        };

        const category = formData.get('category');

        // 确保 posts 对象存在
        if (!posts[category]) {
            posts[category] = [];
        }
        
        // 添加新帖子
        posts[category].push(newPost);
        
        // 保存到 localStorage
        localStorage.setItem('posts', JSON.stringify(posts));
        
        // 更新显示
        displayPosts();
        
        // 重置表单
        this.reset();
        
        // 清空预览
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('avatarPreview').innerHTML = '';
        
        // 显示成功消息
        alert('帖子添加成功！');
    });
}
function savePosts() {
    try {
        const posts = JSON.parse(localStorage.getItem('posts')) || {};
        // ... 保存操作
        localStorage.setItem('posts', JSON.stringify(posts));
        return true;
    } catch (error) {
        console.error('保存帖子时出错:', error);
        alert('保存失败，请重试');
        return false;
    }
}

        // 删除帖子函数
function deletePost(category, postId) {
    if (confirm('确定要删除这篇帖子吗？')) {
        const posts = JSON.parse(localStorage.getItem('posts')) || {};
        
        if (posts[category]) {
            posts[category] = posts[category].filter(p => p.id.toString() !== postId.toString());
            
            // 如果该分类下没有帖子了，删除该分类
            if (posts[category].length === 0) {
                delete posts[category];
            }
            
            localStorage.setItem('posts', JSON.stringify(posts));
            
            // 同时删除该帖子的评论
            let comments = JSON.parse(localStorage.getItem('comments')) || {};
            delete comments[postId];
            localStorage.setItem('comments', JSON.stringify(comments));
            
            displayPosts();
        }
    }
}

        

function getCategoryName(category) {
    const categoryNames = {
        food: '美食',
        pets: '萌宠',
        beauty: '美妆',
        travel: '旅游'
    };
    return categoryNames[category] || category;
}

        
    // 添加评论字段的函数
function addCommentField() {
    const container = document.getElementById('commentsContainer');
    const commentGroup = document.createElement('div');
    commentGroup.className = 'comment-input-group';
    commentGroup.innerHTML = `
        <input type="text" name="commentAuthor[]" placeholder="评论者名称">
        <input type="text" name="commentAvatar[]" placeholder="评论者头像URL">
        <textarea name="commentContent[]" placeholder="评论内容"></textarea>
        <input type="number" name="commentLikes[]" placeholder="点赞数">
        <button type="button" class="remove-comment">删除</button>
    `;
    container.appendChild(commentGroup);
}

// 删除评论字段
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-comment')) {
        e.target.parentElement.remove();
    }
});

// 修改表单提交处理
document.getElementById('postForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // 收集评论数据
    const comments = [];
    const authors = formData.getAll('commentAuthor[]');
    const avatars = formData.getAll('commentAvatar[]');
    const contents = formData.getAll('commentContent[]');
    const commentLikes = formData.getAll('commentLikes[]');
    
    for (let i = 0; i < authors.length; i++) {
        if (authors[i] && contents[i]) {
            comments.push({
                author: authors[i],
                avatar: avatars[i] || 'https://via.placeholder.com/40',
                content: contents[i],
                likes: parseInt(commentLikes[i]) || 0,
                timestamp: new Date().toISOString()
            });
        }
    }

    const newPost = {
        id: Date.now().toString(),
        title: formData.get('title'),
        content: formData.get('content'),
        image: formData.get('image') || 'https://via.placeholder.com/400',
        author: formData.get('author'),
        authorAvatar: formData.get('authorAvatar') || 'https://via.placeholder.com/40',
        isAI: formData.get('isAI') === 'on',
        isAIGenerated: formData.get('isAI') === 'on', // 添加这个字段
        group: formData.get('group'),
        likes: parseInt(formData.get('likes')) || 0,
        favorites: parseInt(formData.get('favorites')) || 0,
        comments: comments,
        timestamp: new Date().toISOString()
    };

    const category = formData.get('category');
    
    // 获取现有帖子数据
    let posts = JSON.parse(localStorage.getItem('posts')) || {};
    
    // 确保分类存在
    if (!posts[category]) {
        posts[category] = [];
    }
    
    // 添加新帖子
    posts[category].push(newPost);
    
    // 保存到 localStorage
    localStorage.setItem('posts', JSON.stringify(posts));
    
    // 更新显示
    displayPosts();
    
    // 重置表单和预览
    this.reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('avatarPreview').innerHTML = '';
    
    alert('帖子添加成功！');
});

// 更新显示帖子的函数
function displayPosts() {
    const posts = JSON.parse(localStorage.getItem('posts')) || {};
    let postsHtml = '';
    
    Object.entries(posts).forEach(([category, categoryPosts]) => {
        if (categoryPosts && categoryPosts.length > 0) {
            postsHtml += `<h3>${getCategoryName(category)}</h3>`;
            categoryPosts.forEach(post => {
                let groupClass = post.group ? `group-${post.group.toLowerCase()}` : '';
                let groupBadge = post.group ? 
                    `<span class="${post.group.toLowerCase()}-badge">${getGroupLabel(post.group)}</span>` : '';
                
                postsHtml += `
                    <div class="post-item ${groupClass}">
                        <div class="post-meta">
                            ${groupBadge}
                            ${post.isAI ? '<span class="badge">AI生成</span>' : ''}
                        </div>
                        <div class="preview-container">
                            <div class="post-media">
                                <img src="${post.image || 'https://via.placeholder.com/400'}" alt="帖子图片">
                            </div>
                            <div class="post-info">
                                <div class="author-info">
                                    <img src="${post.authorAvatar || 'https://via.placeholder.com/40'}" 
                                         alt="作者头像" 
                                         style="width: 40px; height: 40px; border-radius: 50%;">
                                    <span class="author-name">${post.author || '匿名用户'}</span>
                                </div>
                                <h4 class="post-title">${post.title}</h4>
                                <p>${post.content ? post.content.substring(0, 100) + '...' : ''}</p>
                                <div class="post-stats">
                                    <span>👍 ${post.likes || 0}</span>
                                    <span>⭐ ${post.favorites || 0}</span>
                                    <span>💬 ${(post.comments || []).length}</span>
                                </div>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button onclick="editPost('${category}', '${post.id}')" class="edit-button">编辑</button>
                            <button onclick="deletePost('${category}', '${post.id}')" class="delete-button">删除</button>
                        </div>
                    </div>
                `;
            });
        }
    });
    
    if (!postsHtml) {
        postsHtml = '<p>暂无帖子</p>';
    }
    
    document.getElementById('postsList').innerHTML = postsHtml;
}

// 将帖子HTML模板抽取为独立函数
function createPostHTML(post, category) {
    return `
        <div class="post-item ${post.group ? `group-${post.group}` : ''}">
            <div class="preview-container">
                <div class="post-media">
                    <img src="${post.image || 'https://via.placeholder.com/400'}" alt="帖子图片">
                </div>
                <div class="post-info">
                    <div class="author-info">
                        <img src="${post.authorAvatar || 'https://via.placeholder.com/40'}" 
                             alt="作者头像" 
                             style="width: 40px; height: 40px; border-radius: 50%;">
                        <span class="author-name">${post.author || '匿名用户'}</span>
                    </div>
                    <h4 class="post-title">${post.title}</h4>
                    <p>${post.content.substring(0, 100)}...</p>
                    <div class="post-stats">
                        <span>👍 ${post.likes || 0}</span>
                        <span>⭐ ${post.favorites || 0}</span>
                        <span>💬 ${(post.comments || []).length}</span>
                    </div>
                </div>
            </div>
            <div class="post-actions">
                <button onclick="editPost('${category}', '${post.id.toString()}')" class="edit-button">编辑</button>
                <button onclick="deletePost('${category}', '${post.id.toString()}')" class="delete-button">删除</button>
            </div>
        </div>
    `;
}

function displayComments(postId) {
    let comments = JSON.parse(localStorage.getItem('comments')) || {};
    let postComments = comments[postId] || [];
    let commentsHtml = '';
    
    postComments.forEach((comment, index) => {
        commentsHtml += `
            <div class="comment">
                <p>${comment.content}</p>
                <small>评论时间: ${new Date(comment.timestamp).toLocaleString()}</small>
                <button onclick="deleteComment('${postId}', ${index})">删除评论</button>
            </div>
        `;
    });
    
    document.getElementById('comments').innerHTML = commentsHtml;
}
function deleteComment(postId, commentIndex) {
    if (confirm('确定要删除这条评论吗？')) {
        let comments = JSON.parse(localStorage.getItem('comments')) || {};
        
        // 确保该帖子的评论数组存在
        if (comments[postId]) {
            // 删除指定索引的评论
            comments[postId].splice(commentIndex, 1);
            
            // 如果该帖子没有评论了，删除该帖子的评论键
            if (comments[postId].length === 0) {
                delete comments[postId];
            }
            
            // 保存更新后的评论
            localStorage.setItem('comments', JSON.stringify(comments));
            
            // 重新显示评论
            displayComments(postId);
        }
    }
}
// 辅助函数：获取组别显示标签
function getGroupLabel(group) {
    switch(group) {
        case 'A':
            return 'A组内容';
        case 'B':
            return 'B组内容';
        default:
            return '所有用户可见';
    }
}

// 查看评论的函数
function viewComments(postId) {
    let post;
    for (let category in posts) {
        post = posts[category].find(p => p.id === postId);
        if (post) break;
    }
    
    if (post) {
        const comments = post.comments.map(comment => `
            <div style="border-bottom: 1px solid #eee; padding: 10px;">
                <img src="${comment.avatar}" alt="评论者头像" style="width: 30px; height: 30px; border-radius: 50%;">
                <strong>${comment.author}</strong>
                <p>${comment.content}</p>
                <small>点赞数: ${comment.likes}</small>
            </div>
        `).join('');
        
        alert(`评论列表：\n${comments}`);
    }
}
function editPost(category, postId) {
    const posts = JSON.parse(localStorage.getItem('posts')) || {};
    const post = posts[category]?.find(p => p.id.toString() === postId.toString());
    
    if (!post) {
        alert('找不到该帖子，请刷新页面后重试');
        return;
    }

    // 创建编辑表单
    const editForm = `
        <div class="modal" style="display: block;">
            <div class="modal-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <form id="editPostForm" class="edit-form-container">
                    <input type="hidden" name="postId" value="${post.id}">
                    
                    <div class="form-group">
                        <label>标题</label>
                        <input type="text" name="title" class="form-control" value="${post.title || ''}" required>
                    </div>

                    <div class="form-group">
                        <label>详细内容</label>
                        <textarea name="content" class="form-control" required>${post.content || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>图片URL</label>
                        <input type="text" name="image" class="form-control" value="${post.image || ''}" required>
                        <div id="imagePreview">
                            ${post.image ? `<img src="${post.image}" alt="预览图片">` : ''}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>作者</label>
                        <input type="text" name="author" class="form-control" value="${post.author || ''}" required>
                    </div>

                    <div class="form-group">
                        <label>作者头像URL</label>
                        <input type="text" name="authorAvatar" class="form-control" value="${post.authorAvatar || ''}">
                        <div id="avatarPreview">
                            ${post.authorAvatar ? `<img src="${post.authorAvatar}" alt="头像预览">` : ''}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>分类</label>
                        <select name="category" class="form-control">
                            <option value="food" ${category === 'food' ? 'selected' : ''}>美食</option>
                            <option value="pets" ${category === 'pets' ? 'selected' : ''}>萌宠</option>
                            <option value="beauty" ${category === 'beauty' ? 'selected' : ''}>美妆</option>
                            <option value="travel" ${category === 'travel' ? 'selected' : ''}>旅游</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>显示组别</label>
                        <select name="group" class="form-control" required>
                            <option value="A" ${post.group === 'A' ? 'selected' : ''}>A组</option>
                            <option value="B" ${post.group === 'B' ? 'selected' : ''}>B组</option>
                            <option value="both" ${post.group === 'both' ? 'selected' : ''}>两组都显示</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="isAI" ${post.isAI ? 'checked' : ''}>
                            是否为AI生成内容
                        </label>
                    </div>

                    <div class="form-group">
                        <label>点赞数</label>
                        <input type="number" name="likes" class="form-control" value="${post.likes || 0}" min="0">
                    </div>

                    <div class="form-group">
                        <label>收藏数</label>
                        <input type="number" name="favorites" class="form-control" value="${post.favorites || 0}" min="0">
                    </div>

                    <div class="form-group">
                        <h3>评论管理</h3>
                        <div id="editCommentsContainer">
                            ${(post.comments || []).map((comment, index) => `
                                <div class="comment-input-group">
                                    <input type="text" name="commentAuthor[]" value="${comment.author || ''}" placeholder="评论者名称">
                                    <input type="text" name="commentAvatar[]" value="${comment.avatar || ''}" placeholder="评论者头像URL">
                                    <textarea name="commentContent[]" placeholder="评论内容">${comment.content || ''}</textarea>
                                    <input type="number" name="commentLikes[]" value="${comment.likes || 0}" placeholder="点赞数">
                                    <button type="button" class="remove-comment" onclick="removeComment(this)">删除</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" class="button" onclick="addCommentFieldToEdit()">添加评论</button>
                    </div>

                    <button type="submit" class="button">保存更改</button>
                </form>
            </div>
        </div>
    `;

    // 移除可能存在的旧模态框
    const oldModal = document.querySelector('.modal');
    if (oldModal) {
        oldModal.remove();
    }

    // 添加新的编辑表单到页面
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = editForm;
    document.body.appendChild(modalContainer);

    // 添加表单提交事件监听
    const form = modalContainer.querySelector('form');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (await saveEdit(category, postId, this)) {
            closeEditModal();
        }
    });

    // 添加关闭按钮事件监听
    modalContainer.querySelector('.close').addEventListener('click', function(e) {
        e.preventDefault();
        closeEditModal();
    });

    // 添加点击外部关闭功能
    modalContainer.addEventListener('click', function(e) {
        if (e.target === modalContainer) {
            closeEditModal();
        }
    });
}
function removeComment(button) {
    button.closest('.comment-input-group').remove();
}

// 显示评论列表
function displayComments(postId) {
    let comments = JSON.parse(localStorage.getItem('comments')) || {};
    let postComments = comments[postId] || [];
    
    let commentsHtml = '';
    if (postComments.length === 0) {
        commentsHtml = '<p>暂无评论</p>';
    } else {
        postComments.forEach((comment, index) => {
            commentsHtml += `
                <div class="comment-item">
                    <div class="comment-content">
                        <p>${comment.content}</p>
                        <small>${new Date(comment.timestamp).toLocaleString()}</small>
                    </div>
                    <button onclick="deleteComment('${postId}', ${index})" class="delete-btn">
                        删除
                    </button>
                </div>
            `;
        });
    }
    
    document.getElementById('commentsList').innerHTML = commentsHtml;
}

// 添加新评论
function addComment(postId) {
    let content = document.getElementById('newComment').value.trim();
    if (!content) {
        alert('评论内容不能为空');
        return;
    }
    
    let comments = JSON.parse(localStorage.getItem('comments')) || {};
    if (!comments[postId]) {
        comments[postId] = [];
    }
    
    // 添加新评论
    comments[postId].push({
        content: content,
        timestamp: new Date().toISOString()
    });
    
    // 保存到localStorage
    localStorage.setItem('comments', JSON.stringify(comments));
    
    // 清空输入框并刷新显示
    document.getElementById('newComment').value = '';
    displayComments(postId);
}

// 删除评论
function deleteComment(postId, commentIndex) {
    if (confirm('确定要删除这条评论吗？')) {
        let comments = JSON.parse(localStorage.getItem('comments')) || {};
        
        if (comments[postId]) {
            comments[postId].splice(commentIndex, 1);
            if (comments[postId].length === 0) {
                delete comments[postId];
            }
            localStorage.setItem('comments', JSON.stringify(comments));
            displayComments(postId);
        }
    }
}

// 更新帖子的函数
function updatePost(originalCategory, postId) {
    const updatedPost = {
        id: postId,
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value,
        image: document.getElementById('editImage').value,
        author: document.getElementById('editAuthor').value,
        authorAvatar: document.getElementById('editAuthorAvatar').value,
        group: document.getElementById('editGroup').value, // 添加组别
        // 保持原有的统计数据
        likes: posts[originalCategory].find(p => p.id === postId).likes || 0,
        favorites: posts[originalCategory].find(p => p.id === postId).favorites || 0,
        comments: posts[originalCategory].find(p => p.id === postId).comments || []
    };

    const newCategory = document.getElementById('editCategory').value;

    // 从原分类中删除
    posts[originalCategory] = posts[originalCategory].filter(p => p.id !== postId);

    // 添加到新分类
    if (!posts[newCategory]) {
        posts[newCategory] = [];
    }
    posts[newCategory].push(updatedPost);

    // 保存到 localStorage
    localStorage.setItem('posts', JSON.stringify(posts));

    // 关闭模态框并刷新显示
    closeEditModal();
    displayPosts();
}

// 关闭模态框
function closeEditModal() {
    // 找到并移除动态创建的模态框
    const dynamicModal = document.querySelector('.modal');
    if (dynamicModal) {
        dynamicModal.remove();
    }
}

    // 关闭模态框
    document.getElementById('editModal').style.display = 'none';

// 关闭模态框的功能
document.querySelector('.close').onclick = function() {
    document.getElementById('editModal').style.display = 'none';
}

// 点击模态框外部关闭
window.onclick = function(event) {
    const modal = document.getElementById('editModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}


function addCommentFieldToEdit() {
    const container = document.getElementById('editCommentsContainer');
    const commentGroup = document.createElement('div');
    commentGroup.className = 'comment-input-group';
    commentGroup.innerHTML = `
        <input type="text" name="commentAuthor[]" placeholder="评论者名称">
        <input type="text" name="commentAvatar[]" placeholder="评论者头像URL">
        <textarea name="commentContent[]" placeholder="评论内容"></textarea>
        <input type="number" name="commentLikes[]" value="0" placeholder="点赞数">
        <button type="button" class="remove-comment">删除评论</button>
    `;
    container.appendChild(commentGroup);
}



// 导出数据的按钮代码
function exportPosts() {
    const dataStr = JSON.stringify(posts, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'posts-data.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 显示帖子管理界面
function showPosts() {
    document.getElementById('postsList').style.display = 'block';
    document.getElementById('analyticsContainer').style.display = 'none';
    document.getElementById('postForm').style.display = 'block';
    displayPosts(); // 原有的显示帖子函数
}
function exportFullReport() {
        const report = {
            experimentInfo: getExperimentInfo(),
            interactionData: getAllInteractions(),
            analysis: analyzeHypothesis()
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], 
            {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'experiment_report.json';
        a.click();
    }

    function getExperimentInfo() {
        return {
            startDate: localStorage.getItem('experimentStartDate'),
            totalParticipants: getTotalParticipants(),
            groupDistribution: getGroupDistribution()
        };
    }
    

function validatePost(postData) {
    const config = experimentConfig.controls;
    
    // 检查字数
    const wordCount = postData.content.length;
    if (wordCount < config.contentLength.min || 
        wordCount > config.contentLength.max) {
        alert(`字数必须在${config.contentLength.min}-${config.contentLength.max}之间`);
        return false;
    }

    // AI版本必须填写原文ID
    if (postData.version === 'ai' && !postData.originalPostId) {
        alert('AI版本必须填写对应的原文ID');
        return false;
    }

    return true;
}
// 保存编辑的函数
async function saveEdit(category, postId, form) {
    try {
        const posts = JSON.parse(localStorage.getItem('posts')) || {};
        const formData = new FormData(form);
        
        const updatedPost = {
            id: postId.toString(),
            title: formData.get('title'),
            content: formData.get('content'),
            image: formData.get('image'),
            author: formData.get('author'),
            authorAvatar: formData.get('authorAvatar'),
            // 确保组别信息被正确保存
            group: formData.get('group'),
            isAI: formData.get('isAI') === 'on',
            isAIGenerated: formData.get('isAI') === 'on', // 添加这个字段
            likes: parseInt(formData.get('likes')) || 0,
            favorites: parseInt(formData.get('favorites')) || 0,
            contentA: posts[category].find(p => p.id.toString() === postId.toString()).contentA,
            contentB: posts[category].find(p => p.id.toString() === postId.toString()).contentB,
            comments: [], // 初始化评论数组
            timestamp: new Date().toISOString()
        };

        // 收集评论数据
        const authors = formData.getAll('commentAuthor[]');
        const avatars = formData.getAll('commentAvatar[]');
        const contents = formData.getAll('commentContent[]');
        const commentLikes = formData.getAll('commentLikes[]');
        
        for (let i = 0; i < authors.length; i++) {
            if (authors[i] && contents[i]) {
                updatedPost.comments.push({
                    author: authors[i],
                    avatar: avatars[i] || 'https://via.placeholder.com/40',
                    content: contents[i],
                    likes: parseInt(commentLikes[i]) || 0,
                    timestamp: new Date().toISOString()
                });
            }
        }

        const newCategory = formData.get('category');
        
        // 从原分类中删除
        posts[category] = posts[category].filter(p => p.id.toString() !== postId.toString());
        
        // 确保新分类存在
        if (!posts[newCategory]) {
            posts[newCategory] = [];
        }
        
        // 添加到新分类
        posts[newCategory].push(updatedPost);
        
        // 保存到 localStorage
        localStorage.setItem('posts', JSON.stringify(posts));
        
        // 调试输出
        console.log('Saved post:', updatedPost);
        console.log('Updated posts:', posts);
        
        // 刷新显示
        displayPosts();
        
        alert('保存成功！');
        return true;
    } catch (error) {
        console.error('保存失败:', error);
        alert('保存失败，请重试');
        return false;
    }
}

// 添加页面加载完成后的初始化
window.onload = function() {
    // 初始化数据结构
    if (!localStorage.getItem('posts')) {
        localStorage.setItem('posts', JSON.stringify({
            food: [],
            pets: [],
            beauty: [],
            travel: []
        }));
    }
    
    initializeEventListeners();
    displayPosts();
    
    // 确保移除任何可能存在的旧模态框
    const oldModal = document.querySelector('.modal');
    if (oldModal) {
        oldModal.remove();
    }
};
</script>
</body>
</html>
